# SetupLiquidityV3 - é›†ä¸­æµåŠ¨æ€§ç­–ç•¥

## ğŸ“‹ æ¦‚è¿°

`SetupLiquidityV3.s.sol` ä½¿ç”¨**é›†ä¸­æµåŠ¨æ€§ï¼ˆConcentrated Liquidityï¼‰**åˆ›å»ºæ–°çš„ V3 æ± å­ï¼Œå¤§å¹…æé«˜èµ„é‡‘æ•ˆç‡ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆä½¿ç”¨é›†ä¸­æµåŠ¨æ€§ï¼Ÿ

### V2 å…¨èŒƒå›´æµåŠ¨æ€§çš„é—®é¢˜
- âŒ èµ„é‡‘åˆ†æ•£åœ¨æ•´ä¸ªä»·æ ¼èŒƒå›´ï¼ˆtick -887200 åˆ° 887200ï¼‰
- âŒ å¤§éƒ¨åˆ†æµåŠ¨æ€§æ°¸è¿œç”¨ä¸åˆ°ï¼ˆä»·æ ¼ä¸ä¼šæ³¢åŠ¨é‚£ä¹ˆå¤§ï¼‰
- âŒ èµ„é‡‘æ•ˆç‡ä½ï¼šæŠ•å…¥ $5M åªèƒ½æä¾› $5M æµåŠ¨æ€§
- âŒ å•è¾¹æµåŠ¨æ€§ï¼šå‡ ä¹å…¨éƒ¨èµ„é‡‘é›†ä¸­åœ¨ä¸€ç§ä»£å¸

### V3 é›†ä¸­æµåŠ¨æ€§çš„ä¼˜åŠ¿
- âœ… èµ„é‡‘é›†ä¸­åœ¨åˆç†çš„ä»·æ ¼èŒƒå›´ï¼ˆå¦‚ Â±20%ï¼‰
- âœ… èµ„é‡‘æ•ˆç‡é«˜ï¼šæŠ•å…¥ $50M å¯æä¾› **$250M - $500M** ç­‰æ•ˆæµåŠ¨æ€§
- âœ… åŒè¾¹æµåŠ¨æ€§ï¼šä¸¤ç§ä»£å¸éƒ½ä¼šè¢«ä½¿ç”¨
- âœ… æ›´é€‚åˆå®é™…äº¤æ˜“åœºæ™¯

## ğŸ’¡ ç­–ç•¥è®¾è®¡

### ä»·æ ¼èŒƒå›´é€‰æ‹©

| èµ„äº§ç±»å‹ | ä»£å¸ | ä»·æ ¼èŒƒå›´ | åŸå›  |
|---------|------|---------|------|
| ç¨³å®šæ³¢åŠ¨ | WBNB, ETH, BCH | Â±20% | ä¸»æµå¸ç§ï¼Œæ³¢åŠ¨ç›¸å¯¹ç¨³å®š |
| é«˜æ³¢åŠ¨ | BTCB, ADA | Â±30% | ä»·æ ¼æ³¢åŠ¨è¾ƒå¤§ï¼Œéœ€è¦æ›´å®½èŒƒå›´ |

### è´¹ç‡é€‰æ‹©
- **1% (10000)**: ä½¿ç”¨æ–°çš„è´¹ç‡å±‚çº§
- é¿å…ä¸ V1 å’Œ V2 æ± å­å†²çª
- åˆ›å»ºå®Œå…¨ç‹¬ç«‹çš„æ–°æ± å­

### æµåŠ¨æ€§é…ç½®
```solidity
// æ¯ä¸ªæ± å­ç›®æ ‡ TVL (10x increase)
uint256 constant LIQUIDITY_USDT_PER_POOL = 25_000_000 * 1e18; // $25M USDT
// ç­‰å€¼çš„èµ„äº§ä»£å¸

// å®‰å…¨ç³»æ•°ï¼š2xï¼ˆé›†ä¸­æµåŠ¨æ€§æ›´å¯é¢„æµ‹ï¼‰
uint256 constant SAFETY_MULTIPLIER = 2;
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### èµ„é‡‘æ•ˆç‡å¯¹æ¯”

| æ–¹æ¡ˆ | æŠ•å…¥ TVL | æœ‰æ•ˆæµåŠ¨æ€§ | æ•ˆç‡å€æ•° |
|------|---------|-----------|---------|
| V2 å…¨èŒƒå›´ | $25M | ~$2.83M (å®é™…) | 0.11x âŒ |
| **V3 Â±20%** | **$250M** | **$1.25B - $2.5B** | **5-10x** âœ… |
| **V3 Â±30%** | **$250M** | **$830M - $1.66B** | **3.3-6.6x** âœ… |

### äº¤æ˜“æ”¯æŒèƒ½åŠ›

ä»¥ WBNB æ± å­ä¸ºä¾‹ï¼ˆÂ±20% èŒƒå›´ï¼‰ï¼š

| æ–¹æ¡ˆ | æŠ•å…¥ USDT | å®é™… WBNB | æœ‰æ•ˆæµåŠ¨æ€§ | å¯æ”¯æŒäº¤æ˜“ |
|------|----------|----------|-----------|----------|
| V2 å…¨èŒƒå›´ | $500K | 386 BNB | $495K | ~116 BNB |
| **V3 é›†ä¸­** | **$25M** | **~19,200 BNB** | **$125M - $250M** | **15,000-20,000 BNB** âœ… |

âœ… **å®Œå…¨å¯ä»¥æ”¯æŒ 10,000+ BNB çš„äº¤æ˜“ï¼**

## ğŸ”§ æŠ€æœ¯å®ç°

### Tick è®¡ç®—

```solidity
// 1. è®¡ç®—ä»·æ ¼è¾¹ç•Œ
uint256 priceLower = tokenPrice * (100% - range%)
uint256 priceUpper = tokenPrice * (100% + range%)

// 2. è½¬æ¢ä¸º tickï¼ˆç®€åŒ–ç‰ˆï¼‰
// tick â‰ˆ ä»·æ ¼å˜åŒ–çš„åŸºç‚¹æ•°
// 1 bp (0.01%) â‰ˆ 1 tick

// 3. å¯¹é½åˆ° tick spacing (200 for 1% fee tier)
tickLower = roundToTickSpacing(tickLower, 200)
tickUpper = roundToTickSpacing(tickUpper, 200)
```

### å…·ä½“ç¤ºä¾‹ï¼šWBNB æ± å­

å½“å‰ä»·æ ¼ï¼š$1,301.73

```
ä»·æ ¼èŒƒå›´ï¼ˆÂ±20%ï¼‰:
  Lower: $1,301.73 Ã— 0.8 = $1,041.38
  Current: $1,301.73
  Upper: $1,301.73 Ã— 1.2 = $1,562.08

Tick èŒƒå›´:
  Lower tick: -2000 (rounded to -2000)
  Upper tick: +2000 (rounded to +2000)
  Tick spacing: 200
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ‰§è¡Œè„šæœ¬
```bash
forge script script/SetupLiquidityV3.s.sol --rpc-url bnb_testnet --broadcast
```

### é¢„æœŸè¾“å‡º
```
========================================
Setting up V3 Liquidity Pools V3 (Concentrated Liquidity)
========================================
Deployer: 0xB73Ebe02d3A29d61cb3Ee87A3EEdE73cb1A3c725
Strategy: Concentrated liquidity ranges
Fee tier: 1% (10000) - NEW tier
USDT per pool: 25000000 USDT
Target TVL per pool: ~$50M USD ($25M USDT + $25M asset)
Total TVL: ~$250M USD (5 pools)
Effective liquidity: 50-100x due to concentration

Fetching oracle prices...
  WBNB: 1301 USD
  BTCB: 122034 USD
  ETH: 4537 USD
  ADA: 0 USD
  BCH: 579 USD

Pre-minting tokens (with 2x safety factor)...
  USDT: 250000000
  WBNB: 38400
  BTCB: 400
  ETH: 11000
  ADA: 60975600
  BCH: 86200

========================================
Setting up Concentrated Liquidity Pools
========================================

--------------------------------------------------
Setting up WBNB /USDT concentrated pool
--------------------------------------------------
  Token: 0xfadc475b03e3bd7813a71446369204271a0a9843
  Price from oracle: 1301 USD
  Fee tier: 10000 (1%)
  Price range: +/- 20 %
  NFT recipient: 0xB73Ebe02d3A29d61cb3Ee87A3EEdE73cb1A3c725

  Price range:
    Lower: 1041 USD
    Current: 1301 USD
    Upper: 1562 USD
  Tick range:
    Lower tick: -2000
    Upper tick: 2000

  Token amounts:
    Token0: 0xe364204ad025bbcdff6dcb4291f89f532b0a8c35 (USDT)
    Amount0: 25000000
    Token1: 0xfadc475b03e3bd7813a71446369204271a0a9843 (WBNB)
    Amount1: 19200

V3 Pool created successfully!
  Position NFT ID: 24679
  Liquidity: ...
  Amount0 used: 25000000
  Amount1 used: 19200
  Actual TVL: $ 50000000
  Effective liquidity (concentrated): ~$ 250000000 - $ 500000000

[é‡å¤å…¶ä»–4ä¸ªæ± å­...]

========================================
V3 Liquidity Setup Complete
========================================
All 5 concentrated liquidity pools created
Fee tier: 1% (10000)
Position NFTs sent to: 0xB73Ebe02d3A29d61cb3Ee87A3EEdE73cb1A3c725
```

## âœ… é¢„æœŸåˆ›å»ºçš„æ± å­

### V3 é›†ä¸­æµåŠ¨æ€§æ± å­

| ä»£å¸å¯¹ | è´¹ç‡ | ä»·æ ¼èŒƒå›´ | TVL | æœ‰æ•ˆæµåŠ¨æ€§ | Position NFT |
|--------|------|---------|-----|-----------|-------------|
| WBNB/USDT | 1% | Â±20% | $50M | $250M-$500M | æ–° ID |
| BTCB/USDT | 1% | Â±30% | $50M | $166M-$330M | æ–° ID |
| ETH/USDT | 1% | Â±20% | $50M | $250M-$500M | æ–° ID |
| ADA/USDT | 1% | Â±30% | $50M | $166M-$330M | æ–° ID |
| BCH/USDT | 1% | Â±20% | $50M | $250M-$500M | æ–° ID |

**æ€»è®¡**:
- æŠ•å…¥ TVL: **$250M**
- æœ‰æ•ˆæµåŠ¨æ€§: **$1B - $2B**
- èµ„é‡‘æ•ˆç‡: **4-8x**

## ğŸ“ˆ éªŒè¯æ± å­

### æ£€æŸ¥æ± å­åœ°å€
```bash
FACTORY="0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865"
WBNB="0xfadc475b03e3bd7813a71446369204271a0a9843"
USDT="0xe364204ad025bbcdff6dcb4291f89f532b0a8c35"

cast call $FACTORY "getPool(address,address,uint24)(address)" \
  $WBNB $USDT 10000 --rpc-url bnb_testnet
```

### æ£€æŸ¥ Position NFT
```bash
# æŸ¥çœ‹éƒ¨ç½²è€…æŒæœ‰çš„ NFT æ•°é‡
cast call 0x427bF5b37357632377eCbEC9de3626C71A5396c1 \
  "balanceOf(address)(uint256)" \
  0xB73Ebe02d3A29d61cb3Ee87A3EEdE73cb1A3c725 \
  --rpc-url bnb_testnet

# åº”è¯¥è¿”å› 10 (5ä¸ªæ—§ V2 + 5ä¸ªæ–° V3)
```

### æ£€æŸ¥ Position è¯¦æƒ…
```bash
# å‡è®¾æ–°çš„ NFT ID æ˜¯ 24679
cast call 0x427bF5b37357632377eCbEC9de3626C71A5396c1 \
  "positions(uint256)" \
  24679 \
  --rpc-url bnb_testnet
```

## ğŸ”„ åœ¨ Router ä¸­ä½¿ç”¨ V3 æ± å­

### æŒ‡å®šè´¹ç‡è¿›è¡Œäº¤æ˜“
```solidity
ISwapRouter.ExactInputSingleParams memory params = ISwapRouter.ExactInputSingleParams({
    tokenIn: WBNB,
    tokenOut: USDT,
    fee: 10000,  // ä½¿ç”¨ V3 é›†ä¸­æµåŠ¨æ€§æ± å­ (1%)
    recipient: address(this),
    deadline: block.timestamp,
    amountIn: amountIn,
    amountOutMinimum: 0,
    sqrtPriceLimitX96: 0
});
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### ä»·æ ¼èŒƒå›´ç®¡ç†
- å¦‚æœä»·æ ¼è¶…å‡ºèŒƒå›´ï¼ŒæµåŠ¨æ€§å°†å®Œå…¨è½¬æ¢ä¸ºä¸€ç§ä»£å¸
- éœ€è¦å®šæœŸç›‘æ§ä»·æ ¼ï¼Œå¿…è¦æ—¶è°ƒæ•´èŒƒå›´
- å¯ä»¥é€šè¿‡é¢„è¨€æœºä»·æ ¼åŒæ­¥ä¿æŒåœ¨èŒƒå›´å†…

### ä»·æ ¼è¶…å‡ºèŒƒå›´çš„å¤„ç†
å¦‚æœä»·æ ¼ç§»å‡ºèŒƒå›´ï¼š
1. Position ä»ç„¶å­˜åœ¨ï¼Œä½†ä¸æä¾›æµåŠ¨æ€§
2. å¯ä»¥ä½¿ç”¨ `decreaseLiquidity()` ç§»é™¤
3. é‡æ–°åˆ›å»ºæ–°çš„èŒƒå›´å†…çš„ Position
4. æˆ–è€…é€šè¿‡äº¤æ˜“æŠŠä»·æ ¼æ¨å›èŒƒå›´å†…

### è´¹ç‡å½±å“
- 1% è´¹ç‡è¾ƒé«˜ï¼Œé€‚åˆæµ‹è¯•ç¯å¢ƒ
- å¯ä»¥é˜²æ­¢å¤§é‡å¥—åˆ©äº¤æ˜“
- åœ¨ Router ä¸­éœ€è¦æ˜ç¡®æŒ‡å®š `fee: 10000`

## ğŸ†š ä¸‰ä¸ªç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | æµåŠ¨æ€§ç±»å‹ | è´¹ç‡ | TVL | æœ‰æ•ˆæµåŠ¨æ€§ | æ¨èä½¿ç”¨ |
|------|----------|------|-----|-----------|---------|
| V1 | å…¨èŒƒå›´ | 0.01%-0.25% | $64B+ | æ— æ³•æ§åˆ¶ | âŒ åºŸå¼ƒ |
| V2 | å…¨èŒƒå›´ | 0.05%-0.25% | $2.83M | $2.83M | âš ï¸ æµåŠ¨æ€§ä¸è¶³ |
| **V3** | **é›†ä¸­ Â±20-30%** | **1%** | **$25M** | **$100M-$200M** | âœ… **æ¨è** |

## ğŸ“ åç»­æ­¥éª¤

1. âœ… æ‰§è¡Œ SetupLiquidityV3 åˆ›å»ºé›†ä¸­æµåŠ¨æ€§æ± å­
2. â­ éªŒè¯æ± å­åœ°å€å’Œ Position NFT
3. â­ æ›´æ–° deployed-contracts.json æ·»åŠ  `v3PoolsV3` èŠ‚
4. â­ é…ç½® Router ä½¿ç”¨æ–°æ± å­ï¼ˆfee: 10000ï¼‰
5. â­ æµ‹è¯•å¤§é¢äº¤æ˜“ï¼ˆ1000 BNBï¼‰
6. â­ ç›‘æ§ä»·æ ¼èŒƒå›´ï¼Œç¡®ä¿åœ¨èŒƒå›´å†…
7. â­ å¿…è¦æ—¶é€šè¿‡äº¤æ˜“åŒæ­¥ä»·æ ¼åˆ°é¢„è¨€æœºä»·æ ¼

## ğŸ¯ å…³é”®ä¼˜åŠ¿æ€»ç»“

1. **è§£å†³ V2 çš„æ ¸å¿ƒé—®é¢˜**: å•è¾¹æµåŠ¨æ€§ â†’ åŒè¾¹æµåŠ¨æ€§
2. **èµ„é‡‘æ•ˆç‡æå‡**: 0.11x â†’ 4-8xï¼ˆæå‡ 36-72 å€ï¼ï¼‰
3. **æ”¯æŒå¤§é¢äº¤æ˜“**: 116 BNB â†’ 15,000-20,000 BNB
4. **å¯ç®¡ç†æ€§**: Position NFT å½’éƒ¨ç½²è€…æ‰€æœ‰
5. **ç‹¬ç«‹æ€§**: æ–°è´¹ç‡ï¼ˆ1%ï¼‰ä¸å½±å“æ—§æ± å­
6. **è¶…å¤§æµåŠ¨æ€§**: $250M TVL æä¾› $1B-$2B æœ‰æ•ˆæµåŠ¨æ€§

---

**ç‰ˆæœ¬**: v3.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-09
**çŠ¶æ€**: å‡†å¤‡æ‰§è¡Œ
**ç­–ç•¥**: é›†ä¸­æµåŠ¨æ€§ Â±20-30%
