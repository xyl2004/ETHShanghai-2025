# Flash Rebalance æ·±åº¦è§£æ

## æ¦‚è¿°

`flashRebalance()` æ˜¯BlockETFCoreçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œé‡‡ç”¨**Flash Loan**æ¨¡å¼å®ç°é›¶æˆæœ¬èµ„äº§å†å¹³è¡¡ã€‚

**æ ¸å¿ƒç†å¿µï¼š**
- åƒUniswap V3 Flash Swap / Aave Flash Loanä¸€æ ·ï¼Œå…ˆå€Ÿèµ„äº§ç»™rebalancerï¼Œè®©å®ƒå®Œæˆswapï¼Œæœ€åéªŒè¯å½’è¿˜
- æ•´ä¸ªè¿‡ç¨‹åœ¨ä¸€ä¸ªäº¤æ˜“å†…å®Œæˆï¼Œå…·æœ‰åŸå­æ€§

---

## å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLASH REBALANCE è¯¦ç»†æµç¨‹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ETFRebalancerV1
    â”‚
    â”‚ etfCore.flashRebalance(address(this), data)
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BlockETFCore.flashRebalance(receiver, data)                                 â”‚
â”‚                                                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  PHASE 0: æƒé™ä¸æ¡ä»¶æ£€æŸ¥ (Step 1-4)                                           â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 1: è®¿é—®æ§åˆ¶æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  modifier onlyRebalancer {                                         â”‚       â”‚
â”‚  â”‚      require(msg.sender == rebalancer);                            â”‚       â”‚
â”‚  â”‚      // åªæœ‰é…ç½®çš„rebalanceråˆçº¦å¯ä»¥è°ƒç”¨                             â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  modifier onlyInitialized {                                        â”‚       â”‚
â”‚  â”‚      require(initialized);                                         â”‚       â”‚
â”‚  â”‚      // ETFå¿…é¡»å·²åˆå§‹åŒ–                                             â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  modifier nonReentrant {                                           â”‚       â”‚
â”‚  â”‚      // é˜²æ­¢é‡å…¥æ”»å‡»                                                â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 2: åŸºç¡€æ¡ä»¶éªŒè¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // 2.1 ä»·æ ¼é¢„è¨€æœºå¿…é¡»è®¾ç½®                                          â”‚       â”‚
â”‚  â”‚  if (address(priceOracle) == address(0)) {                         â”‚       â”‚
â”‚  â”‚      revert OracleNotSet();                                        â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // 2.2 Rebalancerå¿…é¡»é…ç½®                                          â”‚       â”‚
â”‚  â”‚  if (rebalancer == address(0)) {                                   â”‚       â”‚
â”‚  â”‚      revert RebalanceNotImplemented();                             â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 3: Cooldownæ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  if (block.timestamp < lastRebalanceTime + minRebalanceCooldown) { â”‚       â”‚
â”‚  â”‚      revert CooldownNotMet();                                      â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // minRebalanceCooldowné»˜è®¤å€¼: 1 hour                             â”‚       â”‚
â”‚  â”‚  // ç›®çš„: é˜²æ­¢é¢‘ç¹rebalance                                         â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 4: æ£€æŸ¥æ˜¯å¦éœ€è¦rebalance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  (uint256[] memory currentWeights,                                 â”‚       â”‚
â”‚  â”‚   uint256[] memory targetWeights,                                  â”‚       â”‚
â”‚  â”‚   bool needsRebalance) = getRebalanceInfo();                       â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  if (!needsRebalance) {                                            â”‚       â”‚
â”‚  â”‚      revert RebalanceNotNeeded();                                  â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  PHASE 1: è®¡ç®—Rebalanceéœ€æ±‚ (Step 5-7)                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 5: åˆå§‹åŒ–æ•°æ®ç»“æ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  int256[] memory rebalanceAmounts = new int256[](assets.length);   â”‚       â”‚
â”‚  â”‚  uint256[] memory balancesBefore = new uint256[](assets.length);   â”‚       â”‚
â”‚  â”‚  uint256 totalValueBefore = getTotalValue();                       â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // rebalanceAmountsè¯­ä¹‰:                                          â”‚       â”‚
â”‚  â”‚  // â€¢ amounts[i] > 0  => å–å‡º amounts[i] æ•°é‡                       â”‚       â”‚
â”‚  â”‚  // â€¢ amounts[i] < 0  => ä¹°å…¥ |amounts[i]| æ•°é‡                     â”‚       â”‚
â”‚  â”‚  // â€¢ amounts[i] = 0  => ä¸éœ€è¦è°ƒæ•´                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 6: éå†èµ„äº§è®¡ç®—æ¯ä¸ªèµ„äº§çš„è°ƒæ•´é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  for (uint256 i = 0; i < assets.length; i++) {                    â”‚       â”‚
â”‚  â”‚      address asset = assets[i];                                    â”‚       â”‚
â”‚  â”‚      balancesBefore[i] = IERC20(asset).balanceOf(address(this));   â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // è·å–èµ„äº§ä»·æ ¼å’Œdecimals                                      â”‚       â”‚
â”‚  â”‚      uint256 price = priceOracle.getPrice(asset);                  â”‚       â”‚
â”‚  â”‚      if (price == 0) revert InvalidPrice();                        â”‚       â”‚
â”‚  â”‚      uint8 decimals = IERC20Metadata(asset).decimals();            â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 6.1 å¤„ç†Over-weightedèµ„äº§ï¼ˆéœ€è¦å–å‡ºï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  â”‚      if (currentWeights[i] > targetWeights[i]) {                   â”‚       â”‚
â”‚  â”‚          // è®¡ç®—è¶…é¢æƒé‡                                            â”‚       â”‚
â”‚  â”‚          uint256 excess = currentWeights[i] - targetWeights[i];    â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          // è®¡ç®—è¶…é¢ä»·å€¼ï¼ˆç¾å…ƒï¼‰                                     â”‚       â”‚
â”‚  â”‚          uint256 excessValue = (totalValueBefore * excess) / WEIGHT_PRECISION; â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          // æ¢ç®—æˆèµ„äº§æ•°é‡                                           â”‚       â”‚
â”‚  â”‚          uint256 sellAmount = (excessValue * (10 ** decimals)) / price; â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          // âœ… å®‰å…¨é™åˆ¶: å•æ¬¡æœ€å¤šå–å‡º50%ä½™é¢                          â”‚       â”‚
â”‚  â”‚          uint256 maxSell = balancesBefore[i] / 2;                  â”‚       â”‚
â”‚  â”‚          if (sellAmount > maxSell) {                               â”‚       â”‚
â”‚  â”‚              sellAmount = maxSell;                                 â”‚       â”‚
â”‚  â”‚          }                                                          â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          rebalanceAmounts[i] = int256(sellAmount); // æ­£æ•° = å–å‡º   â”‚       â”‚
â”‚  â”‚      }                                                              â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 6.2 å¤„ç†Under-weightedèµ„äº§ï¼ˆéœ€è¦ä¹°å…¥ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  â”‚      else if (currentWeights[i] < targetWeights[i]) {              â”‚       â”‚
â”‚  â”‚          // è®¡ç®—ç¼ºå£æƒé‡                                            â”‚       â”‚
â”‚  â”‚          uint256 deficit = targetWeights[i] - currentWeights[i];   â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          // è®¡ç®—ç¼ºå£ä»·å€¼ï¼ˆç¾å…ƒï¼‰                                     â”‚       â”‚
â”‚  â”‚          uint256 deficitValue = (totalValueBefore * deficit) / WEIGHT_PRECISION; â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          // æ¢ç®—æˆèµ„äº§æ•°é‡                                           â”‚       â”‚
â”‚  â”‚          uint256 buyAmount = (deficitValue * (10 ** decimals)) / price; â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚          rebalanceAmounts[i] = -int256(buyAmount); // è´Ÿæ•° = ä¹°å…¥   â”‚       â”‚
â”‚  â”‚      }                                                              â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 6.3 æƒé‡ç›¸ç­‰ï¼Œä¸éœ€è¦è°ƒæ•´                                     â”‚       â”‚
â”‚  â”‚      // rebalanceAmounts[i] ä¿æŒ 0                                  â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  PHASE 2: Flash Transferï¼ˆé—ªç”µå€Ÿè´·ï¼‰(Step 7)                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 7: è½¬ç§»å¾…å”®èµ„äº§ç»™Rebalancer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // æ ¸å¿ƒè®¾è®¡: å…ˆæŠŠè¦å–çš„èµ„äº§å€Ÿç»™rebalancer                           â”‚       â”‚
â”‚  â”‚  // è®©å®ƒè‡ªç”±ä½¿ç”¨ï¼Œæœ€åå†éªŒè¯å½’è¿˜                                      â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  for (uint256 i = 0; i < assets.length; i++) {                    â”‚       â”‚
â”‚  â”‚      if (rebalanceAmounts[i] > 0) {  // æ­£æ•° = éœ€è¦å–å‡º             â”‚       â”‚
â”‚  â”‚          uint256 sellAmount = uint256(rebalanceAmounts[i]);        â”‚       â”‚
â”‚  â”‚          IERC20(assets[i]).safeTransfer(receiver, sellAmount);     â”‚       â”‚
â”‚  â”‚          // ç›´æ¥è½¬è´¦ç»™receiverï¼ˆrebalancerï¼‰                         â”‚       â”‚
â”‚  â”‚      }                                                              â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // âš ï¸ æ³¨æ„: æ­¤æ—¶ETFCoreçš„reservesè¿˜æœªæ›´æ–°                           â”‚       â”‚
â”‚  â”‚  //         reservesä¼šåœ¨æœ€åæ ¹æ®å®é™…ä½™é¢æ›´æ–°                          â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  PHASE 3: Callbackæ‰§è¡Œ (Step 8)                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 8: è°ƒç”¨Rebalancerçš„callback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  IRebalanceCallback(receiver).rebalanceCallback(                   â”‚       â”‚
â”‚  â”‚      assets,             // æ‰€æœ‰èµ„äº§åœ°å€                            â”‚       â”‚
â”‚  â”‚      rebalanceAmounts,   // æ¯ä¸ªèµ„äº§çš„è°ƒæ•´é‡ï¼ˆå¸¦ç¬¦å·ï¼‰                â”‚       â”‚
â”‚  â”‚      data                // é¢å¤–æ•°æ®ï¼ˆå¦‚executoråœ°å€ï¼‰                â”‚       â”‚
â”‚  â”‚  );                                                                â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // ğŸ”„ æ­¤æ—¶æ§åˆ¶æµè½¬ç§»åˆ° ETFRebalancerV1.rebalanceCallback()        â”‚       â”‚
â”‚  â”‚  //    Rebalancerä¼š:                                               â”‚       â”‚
â”‚  â”‚  //    1. å–å‡ºover-weightedèµ„äº§æ¢USDT                               â”‚       â”‚
â”‚  â”‚  //    2. ç”¨USDTä¹°å…¥under-weightedèµ„äº§                             â”‚       â”‚
â”‚  â”‚  //    3. å½’è¿˜æ‰€æœ‰èµ„äº§ç»™ETFCore                                     â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // â³ Callbackæ‰§è¡Œå®Œæ¯•åï¼Œæ§åˆ¶æµè¿”å›åˆ°è¿™é‡Œ                          â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  PHASE 4: éªŒè¯ä¸æ›´æ–° (Step 9-13)                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 9: æ”¶é›†callbackåçš„ä½™é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  uint256[] memory balancesAfter = new uint256[](assets.length);    â”‚       â”‚
â”‚  â”‚  uint256[] memory newWeights = new uint256[](assets.length);       â”‚       â”‚
â”‚  â”‚  uint256 totalValueAfter = 0;                                      â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // ç¬¬ä¸€ééå†: è®¡ç®—æ€»ä»·å€¼                                           â”‚       â”‚
â”‚  â”‚  for (uint256 i = 0; i < assets.length; i++) {                    â”‚       â”‚
â”‚  â”‚      address asset = assets[i];                                    â”‚       â”‚
â”‚  â”‚      balancesAfter[i] = IERC20(asset).balanceOf(address(this));    â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      uint256 price = priceOracle.getPrice(asset);                  â”‚       â”‚
â”‚  â”‚      if (price == 0) revert InvalidPrice();                        â”‚       â”‚
â”‚  â”‚      uint8 decimals = IERC20Metadata(asset).decimals();            â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      uint256 assetValue = (balancesAfter[i] * price) / (10 ** decimals); â”‚
â”‚  â”‚      totalValueAfter += assetValue;                                â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 10: éªŒè¯æ¯ä¸ªèµ„äº§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // ç¬¬äºŒééå†: éªŒè¯å’Œæ›´æ–°                                            â”‚       â”‚
â”‚  â”‚  for (uint256 i = 0; i < assets.length; i++) {                    â”‚       â”‚
â”‚  â”‚      address asset = assets[i];                                    â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 10.1 å•èµ„äº§æŸå¤±æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  â”‚      // âœ… ç¡®ä¿å•ä¸ªèµ„äº§ä½™é¢ä¸ä¸‹é™è¶…è¿‡10%                              â”‚       â”‚
â”‚  â”‚      if (balancesAfter[i] < (balancesBefore[i] * 90) / 100) {     â”‚       â”‚
â”‚  â”‚          revert ExcessiveLoss();                                   â”‚       â”‚
â”‚  â”‚      }                                                              â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 10.2 è®¡ç®—æ–°æƒé‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  â”‚      if (totalValueAfter > 0) {                                    â”‚       â”‚
â”‚  â”‚          uint256 price = priceOracle.getPrice(asset);              â”‚       â”‚
â”‚  â”‚          uint8 decimals = IERC20Metadata(asset).decimals();        â”‚       â”‚
â”‚  â”‚          uint256 assetValue = (balancesAfter[i] * price) / (10 ** decimals); â”‚
â”‚  â”‚          newWeights[i] = (assetValue * WEIGHT_PRECISION) / totalValueAfter; â”‚
â”‚  â”‚      }                                                              â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 10.3 æƒé‡æ”¹å–„éªŒè¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  â”‚      uint256 targetWeight = uint256(assetInfo[asset].weight);      â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // è®¡ç®—rebalanceå‰çš„åå·®                                        â”‚       â”‚
â”‚  â”‚      uint256 oldDeviation = currentWeights[i] > targetWeight       â”‚       â”‚
â”‚  â”‚          ? currentWeights[i] - targetWeight                        â”‚       â”‚
â”‚  â”‚          : targetWeight - currentWeights[i];                       â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // è®¡ç®—rebalanceåçš„åå·®                                        â”‚       â”‚
â”‚  â”‚      uint256 newDeviation = newWeights[i] > targetWeight           â”‚       â”‚
â”‚  â”‚          ? newWeights[i] - targetWeight                            â”‚       â”‚
â”‚  â”‚          : targetWeight - newWeights[i];                           â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // âœ… éªŒè¯: åå·®åº”è¯¥å‡å°‘ï¼ˆå…è®¸2%çš„å®¹å·®ç”¨äºgasä¼˜åŒ–ï¼‰               â”‚       â”‚
â”‚  â”‚      if (newDeviation > oldDeviation + 200) {                      â”‚       â”‚
â”‚  â”‚          // å¦‚æœåå·®å¢åŠ è¶…è¿‡2%ï¼Œrevert                               â”‚       â”‚
â”‚  â”‚          revert InvalidRebalance();                                â”‚       â”‚
â”‚  â”‚      }                                                              â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚      // 10.4 æ›´æ–°reserves â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  â”‚      assetInfo[asset].reserve = uint224(balancesAfter[i]);         â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 11: æ€»ä»·å€¼æŸå¤±æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // âœ… ç¡®ä¿æ€»ä»·å€¼ä¸ä¸‹é™è¶…è¿‡5%                                         â”‚       â”‚
â”‚  â”‚  if (totalValueAfter < (totalValueBefore * 95) / 100) {            â”‚       â”‚
â”‚  â”‚      revert ExcessiveLoss();                                       â”‚       â”‚
â”‚  â”‚  }                                                                 â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  // è¯´æ˜: è¿™æ˜¯æœ€ç»ˆçš„é˜²æŠ¤ç½‘                                           â”‚       â”‚
â”‚  â”‚  // å³ä½¿å•ä¸ªèµ„äº§æ²¡è¶…è¿‡10%æŸå¤±ï¼Œä½†æ•´ä½“ä¸èƒ½æŸå¤±è¶…è¿‡5%                      â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 12: æ›´æ–°çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  lastRebalanceTime = block.timestamp;                              â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Step 13: å‘å‡ºäº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â”‚  emit Rebalanced(currentWeights, newWeights);                      â”‚       â”‚
â”‚  â”‚                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                               â”‚
â”‚  âœ… flashRebalance()å®Œæˆ                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†åˆ†æ

### 1. getRebalanceInfo() - åˆ¤æ–­æ˜¯å¦éœ€è¦Rebalance

è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„viewå‡½æ•°ï¼Œç”¨äºåˆ¤æ–­å½“å‰ETFæ˜¯å¦éœ€è¦rebalanceã€‚

```solidity
function getRebalanceInfo()
    public view
    returns (
        uint256[] memory currentWeights,
        uint256[] memory targetWeights,
        bool needsRebalance
    )
{
    currentWeights = new uint256[](assets.length);
    targetWeights = new uint256[](assets.length);
    needsRebalance = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // é¢„æ£€æŸ¥é˜¶æ®µ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Check 1: Cooldownæ£€æŸ¥
    if (block.timestamp < lastRebalanceTime + minRebalanceCooldown) {
        return (currentWeights, targetWeights, false);
    }

    // Check 2: ä»·æ ¼é¢„è¨€æœºæ£€æŸ¥
    if (address(priceOracle) == address(0)) {
        return (currentWeights, targetWeights, needsRebalance);
    }

    // Check 3: æ€»ä»·å€¼æ£€æŸ¥
    uint256 totalValue = getTotalValue();
    if (totalValue == 0) {
        return (currentWeights, targetWeights, needsRebalance);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æƒé‡è®¡ç®—ä¸åå·®æ£€æŸ¥
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    for (uint256 i = 0; i < assets.length; i++) {
        address asset = assets[i];
        AssetInfo memory info = assetInfo[asset];

        // Target weight (ç›®æ ‡æƒé‡ï¼Œæ¥è‡ªé…ç½®)
        targetWeights[i] = uint256(info.weight);

        // Current weight (å½“å‰æƒé‡ï¼ŒåŸºäºå®é™…ä»·å€¼è®¡ç®—)
        if (info.reserve > 0) {
            uint256 price = priceOracle.getPrice(asset);
            if (price > 0) {
                uint8 decimals = IERC20Metadata(asset).decimals();

                // è®¡ç®—èµ„äº§å½“å‰ä»·å€¼
                uint256 assetValue = (info.reserve * price) / (10 ** decimals);

                // è®¡ç®—å½“å‰æƒé‡
                currentWeights[i] = (assetValue * WEIGHT_PRECISION) / totalValue;
            }
        }

        // æ£€æŸ¥åå·®æ˜¯å¦è¶…è¿‡é˜ˆå€¼
        uint256 deviation = currentWeights[i] > targetWeights[i]
            ? currentWeights[i] - targetWeights[i]
            : targetWeights[i] - currentWeights[i];

        if (deviation >= rebalanceThreshold) {
            needsRebalance = true;
        }
    }
}
```

**å…³é”®æ¦‚å¿µï¼š**

| æ¦‚å¿µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `targetWeights[i]` | ç›®æ ‡æƒé‡ï¼ˆé…ç½®å€¼ï¼‰ | 4000 = 40% |
| `currentWeights[i]` | å½“å‰æƒé‡ï¼ˆå®æ—¶è®¡ç®—ï¼‰ | 4500 = 45% |
| `deviation` | åå·®ï¼ˆç»å¯¹å€¼ï¼‰ | \|4500 - 4000\| = 500 (5%) |
| `rebalanceThreshold` | è§¦å‘é˜ˆå€¼ | 300 (3%) |
| `needsRebalance` | æ˜¯å¦éœ€è¦rebalance | deviation >= threshold |

**ç¤ºä¾‹åœºæ™¯ï¼š**

```
ETFé…ç½®:
â€¢ USDT: 40% (4000)
â€¢ WBNB: 20% (2000)
â€¢ BTC:  20% (2000)
â€¢ ETH:  20% (2000)
â€¢ rebalanceThreshold: 300 (3%)

å½“å‰çŠ¶æ€ï¼ˆBTCå¤§æ¶¨åï¼‰:
â€¢ USDT: $38k â†’ 35% (3500)  deviation = |3500-4000| = 500 âŒ è¶…è¿‡é˜ˆå€¼
â€¢ WBNB: $20k â†’ 18.5% (1850)  deviation = |1850-2000| = 150 âœ… æœªè¶…è¿‡
â€¢ BTC:  $30k â†’ 27.8% (2780)  deviation = |2780-2000| = 780 âŒ è¶…è¿‡é˜ˆå€¼
â€¢ ETH:  $20k â†’ 18.5% (1850)  deviation = |1850-2000| = 150 âœ… æœªè¶…è¿‡

ç»“æœ: needsRebalance = trueï¼ˆå› ä¸ºUSDTå’ŒBTCçš„åå·®è¶…è¿‡3%ï¼‰
```

---

### 2. Rebalance Amountè®¡ç®—é€»è¾‘

#### 2.1 Over-weightedèµ„äº§ï¼ˆå–å‡ºï¼‰

```solidity
if (currentWeights[i] > targetWeights[i]) {
    // Step 1: è®¡ç®—è¶…é¢æƒé‡ï¼ˆbasis pointsï¼‰
    uint256 excess = currentWeights[i] - targetWeights[i];
    // ä¾‹: 2780 - 2000 = 780 (7.8%)

    // Step 2: è®¡ç®—è¶…é¢ä»·å€¼ï¼ˆç¾å…ƒï¼‰
    uint256 excessValue = (totalValueBefore * excess) / WEIGHT_PRECISION;
    // ä¾‹: ($108k * 780) / 10000 = $8,424

    // Step 3: æ¢ç®—æˆèµ„äº§æ•°é‡
    uint256 sellAmount = (excessValue * (10 ** decimals)) / price;
    // ä¾‹: ($8,424 * 1e18) / $50,000e18 = 0.16848 BTC

    // Step 4: å®‰å…¨é™åˆ¶ - æœ€å¤šå–å‡º50%
    uint256 maxSell = balancesBefore[i] / 2;
    if (sellAmount > maxSell) {
        sellAmount = maxSell;
    }
    // ä¾‹: å½“å‰æŒæœ‰ 0.6 BTCï¼ŒmaxSell = 0.3 BTC
    //     0.16848 < 0.3ï¼Œä¸éœ€è¦é™åˆ¶

    rebalanceAmounts[i] = int256(sellAmount);
    // ç»“æœ: rebalanceAmounts[2] = 0.16848e18 (æ­£æ•° = å–å‡º)
}
```

**ç¤ºä¾‹è®¡ç®—ï¼š**
```
å‡è®¾ï¼š
â€¢ totalValueBefore = $108,000
â€¢ BTCå½“å‰æƒé‡: 2780 (27.8%)
â€¢ BTCç›®æ ‡æƒé‡: 2000 (20%)
â€¢ BTCä»·æ ¼: $50,000
â€¢ BTCä½™é¢: 0.6ä¸ª

è®¡ç®—è¿‡ç¨‹ï¼š
1. excess = 2780 - 2000 = 780 (7.8%)
2. excessValue = (108,000 * 780) / 10,000 = $8,424
3. sellAmount = (8,424 * 1e18) / 50,000e18 = 0.16848 BTC
4. maxSell = 0.6 / 2 = 0.3 BTC
5. 0.16848 < 0.3 âœ… é€šè¿‡
6. rebalanceAmounts[BTC] = +0.16848e18
```

#### 2.2 Under-weightedèµ„äº§ï¼ˆä¹°å…¥ï¼‰

```solidity
else if (currentWeights[i] < targetWeights[i]) {
    // Step 1: è®¡ç®—ç¼ºå£æƒé‡ï¼ˆbasis pointsï¼‰
    uint256 deficit = targetWeights[i] - currentWeights[i];
    // ä¾‹: 4000 - 3500 = 500 (5%)

    // Step 2: è®¡ç®—ç¼ºå£ä»·å€¼ï¼ˆç¾å…ƒï¼‰
    uint256 deficitValue = (totalValueBefore * deficit) / WEIGHT_PRECISION;
    // ä¾‹: ($108k * 500) / 10000 = $5,400

    // Step 3: æ¢ç®—æˆèµ„äº§æ•°é‡
    uint256 buyAmount = (deficitValue * (10 ** decimals)) / price;
    // ä¾‹: ($5,400 * 1e18) / $1e18 = 5,400 USDT

    rebalanceAmounts[i] = -int256(buyAmount);
    // ç»“æœ: rebalanceAmounts[0] = -5400e18 (è´Ÿæ•° = ä¹°å…¥)
}
```

**ç¤ºä¾‹è®¡ç®—ï¼š**
```
å‡è®¾ï¼š
â€¢ totalValueBefore = $108,000
â€¢ USDTå½“å‰æƒé‡: 3500 (35%)
â€¢ USDTç›®æ ‡æƒé‡: 4000 (40%)
â€¢ USDTä»·æ ¼: $1

è®¡ç®—è¿‡ç¨‹ï¼š
1. deficit = 4000 - 3500 = 500 (5%)
2. deficitValue = (108,000 * 500) / 10,000 = $5,400
3. buyAmount = (5,400 * 1e18) / 1e18 = 5,400 USDT
4. rebalanceAmounts[USDT] = -5400e18
```

#### 2.3 å®Œæ•´ç¤ºä¾‹

```
ETFçŠ¶æ€ï¼ˆBTCå¤§æ¶¨åï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Assetâ”‚ Balance â”‚ Price    â”‚ Value    â”‚ Current â”‚ Target            â”‚
â”‚      â”‚         â”‚          â”‚          â”‚ Weight  â”‚ Weight            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USDT â”‚ 38,000  â”‚ $1       â”‚ $38,000  â”‚ 35.2%   â”‚ 40% (éœ€è¦ä¹°å…¥)    â”‚
â”‚ WBNB â”‚ 66.67   â”‚ $300     â”‚ $20,000  â”‚ 18.5%   â”‚ 20% (åŸºæœ¬æŒå¹³)    â”‚
â”‚ BTC  â”‚ 0.6     â”‚ $50,000  â”‚ $30,000  â”‚ 27.8%   â”‚ 20% (éœ€è¦å–å‡º)    â”‚
â”‚ ETH  â”‚ 6.67    â”‚ $3,000   â”‚ $20,000  â”‚ 18.5%   â”‚ 20% (åŸºæœ¬æŒå¹³)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total Value              â”‚ $108,000                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Rebalanceè®¡ç®—:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Assetâ”‚ Deviation   â”‚ Action      â”‚ rebalanceAmounts[i]             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USDT â”‚ 480 (4.8%)  â”‚ Buy         â”‚ -5,184 USDT (è´Ÿæ•°)              â”‚
â”‚ WBNB â”‚ 150 (1.5%)  â”‚ Skip        â”‚ 0                               â”‚
â”‚ BTC  â”‚ 780 (7.8%)  â”‚ Sell        â”‚ +0.16848 BTC (æ­£æ•°)             â”‚
â”‚ ETH  â”‚ 150 (1.5%)  â”‚ Skip        â”‚ 0                               â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¡ç®—ä¾æ®:
â€¢ USDT: deficit = 4.8%, value = $5,184, amount = 5,184 USDT
â€¢ BTC:  excess = 7.8%, value = $8,424, amount = 0.16848 BTC
```

---

### 3. Flash Transferæœºåˆ¶

```solidity
// Transfer over-weighted assets to receiver (flash loan)
for (uint256 i = 0; i < assets.length; i++) {
    if (rebalanceAmounts[i] > 0) {  // æ­£æ•° = éœ€è¦å–å‡º
        uint256 sellAmount = uint256(rebalanceAmounts[i]);
        IERC20(assets[i]).safeTransfer(receiver, sellAmount);
    }
}
```

**æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š**

1. **å…ˆå€Ÿåè¿˜ï¼ˆFlash Loanï¼‰**
   - ETFCoreå…ˆæŠŠè¦å–çš„èµ„äº§è½¬ç»™Rebalancer
   - Rebalancerå¯ä»¥è‡ªç”±ä½¿ç”¨è¿™äº›èµ„äº§
   - æœ€åéªŒè¯Rebalanceræ˜¯å¦å½’è¿˜äº†æ­£ç¡®çš„èµ„äº§

2. **ä¿¡ä»»æ¨¡å‹**
   - ä¸ä¿¡ä»»Rebalancerä¼šä¸»åŠ¨å½’è¿˜
   - ä¾èµ–æœ€ç»ˆçš„ä½™é¢éªŒè¯
   - å¦‚æœéªŒè¯å¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š

3. **ä¸Uniswap Flash Swapçš„å¯¹æ¯”**

| ç‰¹æ€§ | Uniswap V3 Flash Swap | ETF Flash Rebalance |
|------|----------------------|---------------------|
| å€Ÿå‡º | Poolå€Ÿå‡ºtokenç»™ç”¨æˆ· | ETFCoreå€Ÿå‡ºèµ„äº§ç»™Rebalancer |
| å›è°ƒ | `uniswapV3SwapCallback()` | `rebalanceCallback()` |
| éªŒè¯ | æ£€æŸ¥poolä½™é¢æ˜¯å¦å¢åŠ  | æ£€æŸ¥æ‰€æœ‰èµ„äº§ä½™é¢å’Œä»·å€¼ |
| å¤±è´¥å¤„ç† | Revertæ•´ä¸ªäº¤æ˜“ | Revertæ•´ä¸ªäº¤æ˜“ |
| åŸå­æ€§ | å•ç¬”äº¤æ˜“å†…å®Œæˆ | å•ç¬”äº¤æ˜“å†…å®Œæˆ |

**èµ„äº§æµåŠ¨ç¤ºæ„ï¼š**

```
Before Flash Transfer:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ETF Core       â”‚         â”‚   Rebalancer     â”‚
â”‚                  â”‚         â”‚                  â”‚
â”‚  USDT: 38,000    â”‚         â”‚  USDT: 0         â”‚
â”‚  WBNB: 66.67     â”‚         â”‚  WBNB: 0         â”‚
â”‚  BTC:  0.6       â”‚         â”‚  BTC:  0         â”‚
â”‚  ETH:  6.67      â”‚         â”‚  ETH:  0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After Flash Transfer (è½¬ç§»å¾…å”®èµ„äº§):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ETF Core       â”‚         â”‚   Rebalancer     â”‚
â”‚                  â”‚  â”€â”€â”€â”   â”‚                  â”‚
â”‚  USDT: 38,000    â”‚     â”‚   â”‚  USDT: 0         â”‚
â”‚  WBNB: 66.67     â”‚     â”‚   â”‚  WBNB: 0         â”‚
â”‚  BTC:  0.43152   â”‚     â””â”€â”€>â”‚  BTC:  0.16848   â”‚  â† å€Ÿå‡ºçš„BTC
â”‚  ETH:  6.67      â”‚         â”‚  ETH:  0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

During Callback (Rebalanceræ‰§è¡Œswap):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ETF Core       â”‚         â”‚   Rebalancer     â”‚
â”‚                  â”‚         â”‚                  â”‚
â”‚  (unchanged)     â”‚         â”‚  å–BTC â†’ è·å¾—USDT â”‚
â”‚                  â”‚         â”‚  ç”¨USDT â†’ ä¹°USDT  â”‚
â”‚                  â”‚         â”‚  ...swapping...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After Callback (Rebalancerå½’è¿˜èµ„äº§):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ETF Core       â”‚  <â”€â”€â”€â”  â”‚   Rebalancer     â”‚
â”‚                  â”‚      â”‚  â”‚                  â”‚
â”‚  USDT: 43,184    â”‚  <â”€â”€â”€â”˜  â”‚  USDT: 0         â”‚  â† å…¨éƒ¨å½’è¿˜
â”‚  WBNB: 66.67     â”‚         â”‚  WBNB: 0         â”‚
â”‚  BTC:  0.43152   â”‚         â”‚  BTC:  0         â”‚
â”‚  ETH:  6.67      â”‚         â”‚  ETH:  0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. éªŒè¯æœºåˆ¶

FlashRebalanceæœ‰**ä¸‰å±‚éªŒè¯**ç¡®ä¿å®‰å…¨æ€§ï¼š

#### 4.1 å•èµ„äº§æŸå¤±æ£€æŸ¥ï¼ˆ10%é™åˆ¶ï¼‰

```solidity
if (balancesAfter[i] < (balancesBefore[i] * 90) / 100) {
    revert ExcessiveLoss();
}
```

**ç›®çš„ï¼š** é˜²æ­¢å•ä¸ªèµ„äº§å› ä¸ºswapå¤±è´¥æˆ–è¢«æ¶æ„æ”»å‡»å¯¼è‡´å·¨å¤§æŸå¤±

**ç¤ºä¾‹ï¼š**
```
Before: BTCä½™é¢ = 0.6
After:  BTCä½™é¢ = 0.5

æ£€æŸ¥: 0.5 < 0.6 * 90% = 0.54?
     âœ… 0.5 >= 0.54, é€šè¿‡

å¦‚æœ After = 0.4:
æ£€æŸ¥: 0.4 < 0.54?
     âŒ æ˜¯ï¼Œè§¦å‘ExcessiveLoss revert
```

**æ³¨æ„ï¼š** è¿™ä¸ªæ£€æŸ¥æ¯”è¾ƒå®½æ¾ï¼ˆå…è®¸10%æŸå¤±ï¼‰ï¼Œå› ä¸ºï¼š
- èµ„äº§ä¼šè¢«å–å‡ºï¼ˆä½™é¢è‡ªç„¶ä¸‹é™ï¼‰
- æœ€ç»ˆä¼šé€šè¿‡æ€»ä»·å€¼æ£€æŸ¥ï¼ˆ5%é™åˆ¶ï¼‰

#### 4.2 æƒé‡æ”¹å–„éªŒè¯ï¼ˆ2%å®¹å·®ï¼‰

```solidity
uint256 targetWeight = uint256(assetInfo[asset].weight);

// è®¡ç®—rebalanceå‰çš„åå·®
uint256 oldDeviation = currentWeights[i] > targetWeight
    ? currentWeights[i] - targetWeight
    : targetWeight - currentWeights[i];

// è®¡ç®—rebalanceåçš„åå·®
uint256 newDeviation = newWeights[i] > targetWeight
    ? newWeights[i] - targetWeight
    : targetWeight - newWeights[i];

// éªŒè¯: åå·®åº”è¯¥å‡å°‘ï¼ˆå…è®¸2%å®¹å·®ï¼‰
if (newDeviation > oldDeviation + 200) {
    revert InvalidRebalance();
}
```

**ç›®çš„ï¼š** ç¡®ä¿rebalanceç¡®å®æ”¹å–„äº†æƒé‡åˆ†å¸ƒï¼Œè€Œéæ¶åŒ–

**ç¤ºä¾‹ï¼š**
```
BTC:
â€¢ targetWeight = 2000 (20%)
â€¢ oldDeviation = |2780 - 2000| = 780 (7.8%)

Rebalanceå:
â€¢ newWeights[BTC] = 2100 (21%)
â€¢ newDeviation = |2100 - 2000| = 100 (1%)

éªŒè¯: 100 > 780 + 200 = 980?
     âœ… å¦ï¼Œé€šè¿‡ï¼ˆåå·®ä»7.8%é™åˆ°1%ï¼Œæ”¹å–„äº†ï¼‰

å¦‚æœnewWeights[BTC] = 3000 (30%):
â€¢ newDeviation = |3000 - 2000| = 1000 (10%)
éªŒè¯: 1000 > 980?
     âŒ æ˜¯ï¼Œè§¦å‘InvalidRebalance revertï¼ˆåå·®åè€Œå¢åŠ äº†ï¼‰
```

**2%å®¹å·®çš„æ„ä¹‰ï¼š**
- å…è®¸gasä¼˜åŒ–ï¼ˆä¸éœ€è¦å®Œç¾ç²¾ç¡®ï¼‰
- è€ƒè™‘swapæ»‘ç‚¹å’Œä»·æ ¼æ³¢åŠ¨
- é˜²æ­¢å› å°æ•°èˆå…¥å¯¼è‡´çš„revert

#### 4.3 æ€»ä»·å€¼æŸå¤±æ£€æŸ¥ï¼ˆ5%é™åˆ¶ï¼‰

```solidity
if (totalValueAfter < (totalValueBefore * 95) / 100) {
    revert ExcessiveLoss();
}
```

**ç›®çš„ï¼š** æœ€ç»ˆé˜²æŠ¤ç½‘ï¼Œç¡®ä¿æ•´ä¸ªrebalanceè¿‡ç¨‹æ€»ä»·å€¼æŸå¤±ä¸è¶…è¿‡5%

**ç¤ºä¾‹ï¼š**
```
Before: totalValueBefore = $108,000

After:  totalValueAfter = $104,000

æ£€æŸ¥: $104,000 < $108,000 * 95% = $102,600?
     âœ… å¦ï¼Œé€šè¿‡ï¼ˆæŸå¤±3.7%ï¼Œåœ¨5%é™åˆ¶å†…ï¼‰

å¦‚æœAfter = $100,000:
æ£€æŸ¥: $100,000 < $102,600?
     âŒ æ˜¯ï¼Œè§¦å‘ExcessiveLoss revertï¼ˆæŸå¤±7.4%ï¼Œè¶…è¿‡é™åˆ¶ï¼‰
```

**ä¸‰å±‚éªŒè¯çš„å…³ç³»ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: å•èµ„äº§æŸå¤±æ£€æŸ¥ (10% per asset)               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  é˜²æŠ¤: å•ä¸ªèµ„äº§ä¸èƒ½æŸå¤±è¶…è¿‡10%                          â”‚
â”‚  ç²’åº¦: ç»†ç²’åº¦ï¼ˆper assetï¼‰                              â”‚
â”‚  è§¦å‘: ä»»ä½•ä¸€ä¸ªèµ„äº§ä½™é¢ä¸‹é™è¶…è¿‡10%                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ éƒ½é€šè¿‡
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: æƒé‡æ”¹å–„éªŒè¯ (2% tolerance)                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  é˜²æŠ¤: æƒé‡åå·®ä¸èƒ½æ¶åŒ–ï¼ˆå…è®¸2%å®¹å·®ï¼‰                    â”‚
â”‚  ç²’åº¦: ä¸­ç²’åº¦ï¼ˆper asset weightï¼‰                       â”‚
â”‚  è§¦å‘: ä»»ä½•ä¸€ä¸ªèµ„äº§çš„æƒé‡åå·®å¢åŠ è¶…è¿‡2%                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ éƒ½é€šè¿‡
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: æ€»ä»·å€¼æŸå¤±æ£€æŸ¥ (5% total)                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  é˜²æŠ¤: æ€»ä»·å€¼ä¸èƒ½æŸå¤±è¶…è¿‡5%                              â”‚
â”‚  ç²’åº¦: ç²—ç²’åº¦ï¼ˆaggregateï¼‰                              â”‚
â”‚  è§¦å‘: æ€»ä»·å€¼ä¸‹é™è¶…è¿‡5%                                  â”‚
â”‚  æœ€ç»ˆé˜²æŠ¤ç½‘: å³ä½¿å‰ä¸¤å±‚é€šè¿‡ï¼Œè¿™å±‚ä¹Ÿèƒ½å…œåº•                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. ä¸Rebalancerçš„äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ETFCore â†â†’ Rebalancer äº¤äº’                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: ETFRebalancerV1è°ƒç”¨ETFCore
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ETFRebalancerV1:
    etfCore.flashRebalance(address(this), data)
                  â”‚
                  â”‚ Call
                  â–¼
BlockETFCore:
    onlyRebalancer âœ“  // éªŒè¯msg.sender == rebalancer
    onlyInitialized âœ“
    nonReentrant âœ“


Step 2: ETFCoreè®¡ç®—å¹¶è½¬ç§»èµ„äº§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BlockETFCore:
    1. getRebalanceInfo()
       â†’ currentWeights, targetWeights, needsRebalance

    2. è®¡ç®—rebalanceAmounts[]
       â€¢ amounts[i] > 0  => å–å‡º
       â€¢ amounts[i] < 0  => ä¹°å…¥
       â€¢ amounts[i] = 0  => ä¸åŠ¨

    3. è½¬ç§»å¾…å”®èµ„äº§
       for asset with amounts[i] > 0:
           IERC20(asset).safeTransfer(receiver, amounts[i])


Step 3: ETFCoreè°ƒç”¨Rebalancerçš„callback
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BlockETFCore:
    IRebalanceCallback(receiver).rebalanceCallback(
        assets,
        rebalanceAmounts,
        data
    )
                  â”‚
                  â”‚ Callback
                  â–¼
ETFRebalancerV1:
    rebalanceCallback(assets, amounts, data)
    â”‚
    â”œâ”€ éªŒè¯: msg.sender == etfCore
    â”‚
    â”œâ”€ Phase 1: _sellAssetsForUSDT()
    â”‚   â€¢ å–å‡ºæ‰€æœ‰amounts[i] > 0çš„èµ„äº§
    â”‚   â€¢ æ¢å–USDT
    â”‚   â€¢ è¿”å›totalUSDT
    â”‚
    â”œâ”€ Phase 2: _buyAssetsWithUSDT()
    â”‚   â€¢ ä¼°ç®—USDTéœ€æ±‚
    â”‚   â€¢ è®¡ç®—scaleFactorï¼ˆå¦‚æœUSDTä¸è¶³ï¼‰
    â”‚   â€¢ ä¹°å…¥æ‰€æœ‰amounts[i] < 0çš„èµ„äº§
    â”‚
    â””â”€ Phase 3: _returnAllAssets()
        â€¢ å½’è¿˜æ‰€æœ‰èµ„äº§ç»™ETFCore
        â€¢ åŒ…æ‹¬å‰©ä½™çš„USDT


Step 4: ETFCoreéªŒè¯ç»“æœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BlockETFCore:
    1. æ”¶é›†callbackåçš„ä½™é¢
       balancesAfter[i] = IERC20(asset).balanceOf(address(this))

    2. ä¸‰å±‚éªŒè¯
       â”œâ”€ å•èµ„äº§æŸå¤± < 10% âœ“
       â”œâ”€ æƒé‡åå·®æ”¹å–„ï¼ˆå…è®¸2%å®¹å·®ï¼‰âœ“
       â””â”€ æ€»ä»·å€¼æŸå¤± < 5% âœ“

    3. æ›´æ–°reserves
       assetInfo[asset].reserve = balancesAfter[i]

    4. æ›´æ–°lastRebalanceTime

    5. emit Rebalanced(currentWeights, newWeights)


Step 5: è¿”å›ETFRebalancerV1
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BlockETFCore:
    flashRebalance()è¿”å›
                  â”‚
                  â”‚ Return
                  â–¼
ETFRebalancerV1:
    executeRebalance()ç»§ç»­æ‰§è¡Œ

    1. æ›´æ–°lastRebalanceTime
    2. éªŒè¯aggregate slippage (3%)
    3. emit RebalanceExecuted(...)
```

---

## å®‰å…¨æœºåˆ¶æ€»ç»“

### è®¿é—®æ§åˆ¶

| æ£€æŸ¥é¡¹ | å®ç° | ç›®çš„ |
|--------|------|------|
| `onlyRebalancer` | `msg.sender == rebalancer` | åªæœ‰æˆæƒçš„rebalancerå¯è°ƒç”¨ |
| `onlyInitialized` | `require(initialized)` | ETFå¿…é¡»å·²åˆå§‹åŒ– |
| `nonReentrant` | OpenZeppelin ReentrancyGuard | é˜²æ­¢é‡å…¥æ”»å‡» |

### æ—¶é—´æ§åˆ¶

| æ£€æŸ¥é¡¹ | æ¡ä»¶ | é»˜è®¤å€¼ | ç›®çš„ |
|--------|------|--------|------|
| Cooldown | `block.timestamp >= lastRebalanceTime + minRebalanceCooldown` | 1 hour | é˜²æ­¢é¢‘ç¹rebalance |

### ä»·å€¼ä¿æŠ¤

| å±‚çº§ | æ£€æŸ¥ | é˜ˆå€¼ | ä½œç”¨èŒƒå›´ |
|------|------|------|---------|
| Layer 1 | å•èµ„äº§ä½™é¢æ£€æŸ¥ | -10% | æ¯ä¸ªèµ„äº§ |
| Layer 2 | æƒé‡æ”¹å–„éªŒè¯ | +2% å®¹å·® | æ¯ä¸ªèµ„äº§æƒé‡ |
| Layer 3 | æ€»ä»·å€¼æŸå¤±æ£€æŸ¥ | -5% | æ•´ä½“ |

### æ•°é‡é™åˆ¶

| é™åˆ¶ | æ¡ä»¶ | ç›®çš„ |
|------|------|------|
| æœ€å¤§å–å‡ºé‡ | â‰¤ 50% å½“å‰ä½™é¢ | é˜²æ­¢è¿‡åº¦å–å‡ºå•ä¸ªèµ„äº§ |

---

## æ½œåœ¨é£é™©ä¸ç¼“è§£

### é£é™©1: Rebalanceræ¶æ„è¡Œä¸º

**é£é™©ï¼š** Rebalancerå¯èƒ½ä¸å½’è¿˜èµ„äº§æˆ–å½’è¿˜é”™è¯¯æ•°é‡

**ç¼“è§£ï¼š**
- âœ… ä¸‰å±‚éªŒè¯ï¼ˆä½™é¢ã€æƒé‡ã€æ€»ä»·å€¼ï¼‰
- âœ… åŸå­æ€§ï¼ˆéªŒè¯å¤±è´¥è‡ªåŠ¨å›æ»šï¼‰
- âœ… `onlyRebalancer`é™åˆ¶ï¼ˆåªæœ‰æˆæƒåˆçº¦å¯è°ƒç”¨ï¼‰

### é£é™©2: ä»·æ ¼æ“çºµ

**é£é™©ï¼š** æ”»å‡»è€…é€šè¿‡DEXæ“çºµä»·æ ¼ï¼Œå½±å“rebalance

**ç¼“è§£ï¼š**
- âœ… ä½¿ç”¨ä»·æ ¼é¢„è¨€æœºï¼ˆè€ŒéDEXå³æ—¶ä»·æ ¼ï¼‰
- âœ… 5%æ€»ä»·å€¼æŸå¤±é™åˆ¶
- âœ… Cooldownæœºåˆ¶ï¼ˆç»™å¸‚åœºæ—¶é—´æ¢å¤ï¼‰

### é£é™©3: Flash Loanæ”»å‡»

**é£é™©ï¼š** æ”»å‡»è€…åˆ©ç”¨flash loanåœ¨callbackä¸­åšæ¶

**ç¼“è§£ï¼š**
- âœ… `nonReentrant`é˜²æ­¢é‡å…¥
- âœ… RebalanceréªŒè¯`msg.sender == etfCore`
- âœ… ETFCoreçš„`onlyRebalancer`é™åˆ¶

### é£é™©4: è®¡ç®—æº¢å‡º/ä¸‹æº¢

**é£é™©ï¼š** å¤§æ•°è®¡ç®—å¯èƒ½æº¢å‡º

**ç¼“è§£ï¼š**
- âœ… Solidity 0.8+å†…ç½®æº¢å‡ºæ£€æŸ¥
- âœ… SafeERC20é˜²æ­¢transferå¤±è´¥
- âœ… ä»·æ ¼ä¸º0çš„æ£€æŸ¥

---

## Gasä¼˜åŒ–å»ºè®®

### å½“å‰Gasæ¶ˆè€—ä¼°ç®—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œ                                  â”‚ Gasæ¶ˆè€—  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ flashRebalance()å…¥å£ + æ£€æŸ¥           â”‚ ~50k     â”‚
â”‚ getRebalanceInfo()                   â”‚ ~30k     â”‚
â”‚ è®¡ç®—rebalanceAmounts (4 assets)      â”‚ ~40k     â”‚
â”‚ Flash transfer (2 assets)            â”‚ ~80k     â”‚
â”‚ rebalanceCallback                    â”‚ ~500k    â”‚
â”‚ éªŒè¯ (3å±‚ * 4 assets)                â”‚ ~100k    â”‚
â”‚ æ›´æ–°reserves (4 assets)              â”‚ ~40k     â”‚
â”‚ äº‹ä»¶                                  â”‚ ~10k     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                                  â”‚ ~850k    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŒ–æ–¹å‘

1. **å‡å°‘storageè¯»å†™**
   - å½“å‰ï¼šæ¯ä¸ªèµ„äº§å¤šæ¬¡è¯»å–`assetInfo`
   - ä¼˜åŒ–ï¼šç¼“å­˜åˆ°memory

2. **æ‰¹é‡æ“ä½œ**
   - å½“å‰ï¼šåˆ†åˆ«è®¡ç®—æ¯ä¸ªèµ„äº§
   - ä¼˜åŒ–ï¼šå‘é‡åŒ–è®¡ç®—ï¼ˆå¦‚æœgaså…è®¸ï¼‰

3. **Early return**
   - å½“å‰ï¼šæŸäº›æ£€æŸ¥å¯ä»¥æ›´æ—©æ‰§è¡Œ
   - ä¼˜åŒ–ï¼šåœ¨è®¡ç®—å‰å°±éªŒè¯åŸºæœ¬æ¡ä»¶

---

## ä¸å…¶ä»–DeFiåè®®å¯¹æ¯”

| ç‰¹æ€§ | Uniswap V3 Flash | Aave Flash Loan | ETF Flash Rebalance |
|------|------------------|-----------------|---------------------|
| å€Ÿå‡ºèµ„äº§ | Pool liquidity | Pool liquidity | ETF holdings |
| å›è°ƒå‡½æ•° | `uniswapV3SwapCallback` | `executeOperation` | `rebalanceCallback` |
| è´¹ç”¨ | Swap fee | Flash loan fee (0.09%) | æ— ï¼ˆå†…éƒ¨æ“ä½œï¼‰ |
| éªŒè¯æ–¹å¼ | Pool balanceå¢åŠ  | å½’è¿˜æœ¬é‡‘+è´¹ç”¨ | 3å±‚éªŒè¯ |
| ä½¿ç”¨åœºæ™¯ | å¥—åˆ©ã€æ¸…ç®— | å¥—åˆ©ã€æ¸…ç®—ã€å†èèµ„ | èµ„äº§å†å¹³è¡¡ |
| åŸå­æ€§ | âœ… | âœ… | âœ… |

---

## æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿ âœ…

1. **èµ„æœ¬æ•ˆç‡**
   - æ— éœ€é¢å¤–èµ„é‡‘æ³¨å…¥
   - åˆ©ç”¨ETFè‡ªèº«èµ„äº§å®Œæˆrebalance

2. **åŸå­æ€§ä¿è¯**
   - å•ç¬”äº¤æ˜“å®Œæˆ
   - å¤±è´¥è‡ªåŠ¨å›æ»š

3. **å¤šå±‚ä¿æŠ¤**
   - è®¿é—®æ§åˆ¶
   - æ—¶é—´æ§åˆ¶
   - ä»·å€¼ä¿æŠ¤ï¼ˆ3å±‚ï¼‰

4. **çµæ´»æ€§**
   - æ”¯æŒä»»æ„æ•°é‡èµ„äº§
   - è‡ªåŠ¨è®¡ç®—rebalanceéœ€æ±‚
   - å¯é…ç½®çš„é˜ˆå€¼å’Œé™åˆ¶

### ä¸»è¦é™åˆ¶ âš ï¸

1. **ä¾èµ–ä»·æ ¼é¢„è¨€æœº**
   - å¦‚æœé¢„è¨€æœºå¤±è´¥ï¼Œæ— æ³•rebalance
   - ä»·æ ¼å»¶è¿Ÿå¯èƒ½å½±å“ç²¾ç¡®åº¦

2. **50%å–å‡ºé™åˆ¶**
   - é˜²æ­¢è¿‡åº¦å–å‡º
   - ä½†å¯èƒ½å¯¼è‡´æ— æ³•å®Œå…¨rebalanceåˆ°ç›®æ ‡æƒé‡

3. **æƒé‡æ”¹å–„å®¹å·®**
   - 2%å®¹å·®å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹è¿‡äºå®½æ¾
   - æç«¯å¸‚åœºå¯èƒ½éœ€è¦å¤šæ¬¡rebalance

4. **Gasæˆæœ¬**
   - ~850k gas per rebalance
   - é«˜gasä»·æ ¼æ—¶å¯èƒ½ä¸ç»æµ

### æ”¹è¿›å»ºè®®

1. **P0 - å¢å¼ºéªŒè¯**
   - æ·»åŠ DEXæŠ¥ä»·ä½œä¸ºä»·æ ¼é¢„è¨€æœºçš„è¡¥å……éªŒè¯
   - åœ¨ä»·æ ¼å¼‚å¸¸æ—¶æ‹’ç»rebalance

2. **P1 - Gasä¼˜åŒ–**
   - ç¼“å­˜storageå˜é‡åˆ°memory
   - å‡å°‘é‡å¤çš„ä»·æ ¼æŸ¥è¯¢

3. **P2 - çµæ´»æ€§å¢å¼º**
   - å¯é…ç½®çš„å•èµ„äº§æŸå¤±é™åˆ¶ï¼ˆå½“å‰å›ºå®š10%ï¼‰
   - å¯é…ç½®çš„æœ€å¤§å–å‡ºæ¯”ä¾‹ï¼ˆå½“å‰å›ºå®š50%ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**ç”Ÿæˆæ—¶é—´ï¼š** 2025-09-30
**ä½œè€…ï¼š** Claude Code
**ç›¸å…³æ–‡æ¡£ï¼š**
- `REBALANCE_FLOW_DETAILED.md` - å®Œæ•´rebalanceæµç¨‹
- `BUY_ASSETS_OPTIMIZATION_ANALYSIS.md` - Rebalancerä¹°å…¥ä¼˜åŒ–