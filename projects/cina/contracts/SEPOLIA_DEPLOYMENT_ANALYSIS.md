# Sepolia æµ‹è¯•ç½‘éƒ¨ç½²è¯Šæ–­æŠ¥å‘Š

**è¯Šæ–­æ—¶é—´**: 2025-10-15  
**è¯Šæ–­å·¥å…·**: `scripts/diagnose-sepolia-readonly.ts`

## ğŸ“Š å½“å‰éƒ¨ç½²çŠ¶æ€æ€»è§ˆ

### âœ… å·²æˆåŠŸéƒ¨ç½²çš„åˆçº¦ (10/10)

| åˆçº¦åç§° | åœ°å€ | çŠ¶æ€ |
|---------|------|------|
| FxUSD | `0x085a1b6da46aE375b35Dea9920a276Ef571E209c` | âœ… å·²éƒ¨ç½² |
| PoolManager | `0xBb644076500Ea106d9029B382C4d49f56225cB82` | âœ… å·²éƒ¨ç½² |
| FxUSDBasePool | `0x420D6b8546F14C394A703F5ac167619760A721A9` | âœ… å·²éƒ¨ç½² |
| PegKeeper | `0x628648849647722144181c9CB5bbE0CCadd50029` | âœ… å·²éƒ¨ç½² |
| AaveFundingPool | `0xAb20B978021333091CA307BB09E022Cec26E8608` | âœ… å·²éƒ¨ç½² |
| ReservePool | `0x3908720b490a2368519318dD15295c22cd494e34` | âœ… å·²éƒ¨ç½² |
| RevenuePool | `0x54AC8d19ffc522246d9b87ED956de4Fa0590369A` | âœ… å·²éƒ¨ç½² |
| PoolConfiguration | `0x35456038942C91eb16fe2E33C213135E75f8d188` | âœ… å·²éƒ¨ç½² |
| ProxyAdmin | `0x7bc6535d75541125fb3b494deCfdE10Db20C16d8` | âœ… å·²éƒ¨ç½² |
| AaveFundingPoolImpl | `0x33263fF0D348427542ee4dBF9069d411ac43718E` | âœ… å·²éƒ¨ç½² |

## ğŸ”´ ä¸¥é‡é—®é¢˜

### 1. **PoolManager Configuration æœªè®¾ç½®** ğŸ”¥ğŸ”¥ğŸ”¥

**é—®é¢˜**: PoolManager.configuration() è¿”å› `0x0000...0000`  
**å½±å“**: è¿™ä¼šå¯¼è‡´æ‰€æœ‰éœ€è¦é…ç½®çš„æ“ä½œå¤±è´¥ï¼ŒåŒ…æ‹¬å¼€ä»“ã€å¹³ä»“ç­‰  
**ä¼˜å…ˆçº§**: **æœ€é«˜ - å¿…é¡»ç«‹å³ä¿®å¤**

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// éœ€è¦è°ƒç”¨ PoolManager çš„ç®¡ç†å‘˜æ–¹æ³•è®¾ç½® configuration
await poolManager.updateConfiguration("0x35456038942C91eb16fe2E33C213135E75f8d188");
```

### 2. **AaveFundingPool è°ƒç”¨å¤±è´¥** ğŸ”¥ğŸ”¥

**é—®é¢˜**: æ— æ³•è°ƒç”¨ `collateral()` ç­‰æ–¹æ³•ï¼Œè¿”å› missing revert data  
**å¯èƒ½åŸå› **:
- åˆçº¦æœªæ­£ç¡®åˆå§‹åŒ–
- åˆçº¦ä»£ç æœ‰bug
- ä»£ç†é…ç½®é—®é¢˜

**å½±å“**: æ— æ³•ä½¿ç”¨ AaveFundingPool è¿›è¡Œä»»ä½•æ“ä½œ  
**ä¼˜å…ˆçº§**: **é«˜ - éœ€è¦ç´§æ€¥æ£€æŸ¥**

**å»ºè®®è°ƒæŸ¥æ­¥éª¤**:
1. æ£€æŸ¥åˆçº¦æ˜¯å¦å·²æ­£ç¡®åˆå§‹åŒ–
2. éªŒè¯ä»£ç†æ˜¯å¦æŒ‡å‘æ­£ç¡®çš„å®ç°
3. æ£€æŸ¥åˆçº¦ ABI æ˜¯å¦åŒ¹é…

### 3. **PoolConfiguration è°ƒç”¨å¤±è´¥** ğŸ”¥ğŸ”¥

**é—®é¢˜**: æ— æ³•è°ƒç”¨ `fxUSDPriceOracle()` ç­‰æ–¹æ³•  
**å¯èƒ½åŸå› **: ç±»ä¼¼ AaveFundingPoolï¼Œå¯èƒ½æ˜¯åˆå§‹åŒ–æˆ–ä»£ç†é…ç½®é—®é¢˜

### 4. **PoolManager ä¸­ fxUSD åœ°å€ä¸åŒ¹é…** âš ï¸

**å½“å‰å€¼**: `0x085a1b6da46aE375b35Dea9920a276Ef571E209c`  
**æœŸæœ›å€¼**: `0x085a1b6da46ae375b35dea9920a276ef571e209c` (å°å†™)

è¿™å¯èƒ½åªæ˜¯å¤§å°å†™é—®é¢˜ï¼Œéœ€è¦ç¡®è®¤ã€‚

## âŒ ç¼ºå¤±çš„ä¸»ç½‘åˆçº¦

### 1. **Router (Diamond Proxy)** ğŸ”¥ğŸ”¥

**ä¸»ç½‘åœ°å€**: `0x33636D49FbefBE798e15e7F356E8DBef543CC708`  
**çŠ¶æ€**: Sepolia æœªéƒ¨ç½²  
**ç”¨é€”**: 
- æä¾›ç”¨æˆ·å‹å¥½çš„å‰ç«¯äº¤äº’æ¥å£
- æ”¯æŒé—ªç”µè´·å¼€ä»“
- æ‰¹é‡æ“ä½œ

**éƒ¨ç½²å»ºè®®**: 
- ä½¿ç”¨ç°æœ‰çš„ `ignition/modules/Router.ts`
- éœ€è¦å…ˆéƒ¨ç½² ERC2535 Facets

### 2. **StETHPriceOracle** ğŸ”¥ğŸ”¥

**ä¸»ç½‘åœ°å€**: `0x3716352d57C2e48EEdB56Ee0712Ef29E0c2f3069`  
**çŠ¶æ€**: Sepolia æœªéƒ¨ç½²  
**ç”¨é€”**: 
- ä¸º wstETH æ± æä¾›ä»·æ ¼æº
- æ•´åˆ Chainlink å’Œ Curve ä»·æ ¼

**éƒ¨ç½²æŒ‘æˆ˜**:
- Sepolia ä¸Šå¯èƒ½ç¼ºå°‘ Curve stETH/ETH æ± 
- éœ€è¦ Chainlink ETH/USD ä»·æ ¼æº
- **å»ºè®®**: éƒ¨ç½² Mock Price Oracle ç”¨äºæµ‹è¯•

### 3. **WstETHPool** ğŸ”¥

**ä¸»ç½‘åœ°å€**: `0x6Ecfa38FeE8a5277B91eFdA204c235814F0122E8`  
**çŠ¶æ€**: Sepolia æœªéƒ¨ç½²  
**ç”¨é€”**: 
- æä¾› wstETH ä½œä¸ºæŠµæŠ¼å“çš„é•¿ä»“åŠŸèƒ½

**ä¾èµ–**:
- StETHPriceOracle (æˆ– Mock ç‰ˆæœ¬)
- PoolManager å’Œ PoolConfiguration æ­£å¸¸å·¥ä½œ

## ğŸ“‹ å»ºè®®çš„ä¿®å¤å’Œéƒ¨ç½²è®¡åˆ’

### **é˜¶æ®µ 1: ç´§æ€¥ä¿®å¤ï¼ˆå¿…é¡»ï¼‰** ğŸ”¥ğŸ”¥ğŸ”¥

#### 1.1 ä¿®å¤ PoolManager Configuration
```bash
# åˆ›å»ºä¿®å¤è„šæœ¬
npx hardhat run scripts/fix-pool-manager-config.ts --network sepolia
```

**æ“ä½œ**:
- è°ƒç”¨ PoolManager è®¾ç½® configuration åœ°å€
- éªŒè¯è®¾ç½®æˆåŠŸ

#### 1.2 è¯Šæ–­ AaveFundingPool é—®é¢˜
```bash
# æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
npx hardhat run scripts/check-aave-pool-init.ts --network sepolia
```

**å¯èƒ½éœ€è¦çš„æ“ä½œ**:
- é‡æ–°éƒ¨ç½² AaveFundingPool Implementation
- é€šè¿‡ ProxyAdmin å‡çº§
- é‡æ–°åˆå§‹åŒ–ï¼ˆå¦‚æœæ”¯æŒï¼‰

#### 1.3 ä¿®å¤ PoolConfiguration
ç±»ä¼¼ AaveFundingPoolï¼Œæ£€æŸ¥å¹¶ä¿®å¤åˆå§‹åŒ–é—®é¢˜

### **é˜¶æ®µ 2: éƒ¨ç½² Router ç³»ç»Ÿï¼ˆå¼ºçƒˆæ¨èï¼‰** ğŸ”¥ğŸ”¥

```bash
# 1. éƒ¨ç½² ERC2535 Facets
npx hardhat ignition deploy ignition/modules/ERC2535.ts --network sepolia

# 2. éƒ¨ç½² Router (Diamond)
npx hardhat ignition deploy ignition/modules/Router.ts --network sepolia \
  --parameters ignition/parameters/sepolia-router.json
```

**å¥½å¤„**:
- æ”¹å–„ç”¨æˆ·ä½“éªŒ
- æ”¯æŒé«˜çº§åŠŸèƒ½ï¼ˆé—ªç”µè´·å¼€ä»“ç­‰ï¼‰
- æ›´æ¥è¿‘ä¸»ç½‘ç¯å¢ƒ

### **é˜¶æ®µ 3: éƒ¨ç½²ä»·æ ¼é¢„è¨€æœºå’Œ WstETH æ± ï¼ˆå¯é€‰ï¼‰** ğŸ”¥

#### é€‰é¡¹ A: éƒ¨ç½² Mock Oracleï¼ˆæ¨èç”¨äºæµ‹è¯•ï¼‰

```bash
# éƒ¨ç½²ç®€å•çš„ Mock Price Oracle
npx hardhat run scripts/deploy-mock-oracle.ts --network sepolia
```

**ä¼˜ç‚¹**:
- å¿«é€Ÿéƒ¨ç½²
- ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡
- ä»·æ ¼å¯æ§ï¼Œä¾¿äºæµ‹è¯•

**ç¼ºç‚¹**:
- ä¸çœŸå®åæ˜ å¸‚åœºä»·æ ¼
- ä»…ç”¨äºæµ‹è¯•

#### é€‰é¡¹ B: éƒ¨ç½²çœŸå® Price Oracleï¼ˆæ¥è¿‘ç”Ÿäº§ç¯å¢ƒï¼‰

**æŒ‘æˆ˜**:
- Sepolia ä¸Š Curve stETH/ETH æ± å¯èƒ½ä¸å­˜åœ¨
- éœ€è¦æ‰¾åˆ°æ›¿ä»£çš„ä»·æ ¼æº
- é…ç½®æ›´å¤æ‚

**å»ºè®®**: å…ˆä½¿ç”¨ Mock Oracleï¼Œåç»­éœ€è¦æ—¶å†å‡çº§

### **é˜¶æ®µ 4: æ‰©å±•åŠŸèƒ½ï¼ˆä½ä¼˜å…ˆçº§ï¼‰**

- éƒ¨ç½² WstETHPool
- éƒ¨ç½²çŸ­ä»“ç³»ç»Ÿ (ShortPoolManager)
- éƒ¨ç½²å…¶ä»–è¾…åŠ©åˆçº¦

## ğŸ› ï¸ ç«‹å³è¡ŒåŠ¨æ¸…å•

### ä»Šå¤©å¿…é¡»å®Œæˆ:

1. âœ… **æ‰§è¡Œè¯Šæ–­** - å·²å®Œæˆ
2. â³ **åˆ›å»ºä¿®å¤è„šæœ¬** - è¿›è¡Œä¸­
3. â³ **ä¿®å¤ PoolManager Configuration**
4. â³ **è¯Šæ–­ AaveFundingPool é—®é¢˜**

### æœ¬å‘¨å®Œæˆ:

5. â³ **éƒ¨ç½² Router ç³»ç»Ÿ**
6. â³ **éƒ¨ç½² Mock Price Oracle**
7. â³ **æµ‹è¯•å®Œæ•´çš„å¼€ä»“æµç¨‹**

### å¯é€‰ï¼ˆæ ¹æ®éœ€æ±‚ï¼‰:

8. â³ **éƒ¨ç½² WstETHPool**
9. â³ **éƒ¨ç½²çŸ­ä»“ç³»ç»Ÿ**
10. â³ **éƒ¨ç½²çœŸå® Price Oracle**

## ğŸ’¡ å…³é”®å»ºè®®

### 1. ä¼˜å…ˆä¿®å¤è€Œéæ‰©å±•
**å½“å‰æœ€é‡è¦çš„æ˜¯ä¿®å¤å·²éƒ¨ç½²åˆçº¦çš„é…ç½®é—®é¢˜ï¼Œè€Œä¸æ˜¯éƒ¨ç½²æ–°åˆçº¦ã€‚**

### 2. ä½¿ç”¨ Mock åˆçº¦åŠ é€Ÿæµ‹è¯•
å¯¹äº Sepolia æµ‹è¯•ç½‘ï¼š
- ä½¿ç”¨ Mock Price Oracle ä»£æ›¿çœŸå®çš„ Chainlink/Curve
- ä½¿ç”¨ç®€åŒ–çš„é…ç½®
- ä¸“æ³¨äºåŠŸèƒ½æµ‹è¯•è€Œéä»·æ ¼å‡†ç¡®æ€§

### 3. é€æ­¥éƒ¨ç½²ï¼Œå……åˆ†æµ‹è¯•
- æ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œå……åˆ†æµ‹è¯•
- ç¡®ä¿åŸºç¡€åŠŸèƒ½æ­£å¸¸åå†æ‰©å±•
- ä¿ç•™è¯¦ç»†çš„éƒ¨ç½²å’Œæµ‹è¯•æ—¥å¿—

### 4. æ³¨æ„ Sepolia ä¸ä¸»ç½‘çš„å·®å¼‚

| ç‰¹æ€§ | ä¸»ç½‘ | Sepolia æµ‹è¯•ç½‘ |
|------|------|--------------|
| Curve æ±  | ä¸°å¯Œ | å¾ˆå°‘æˆ–ä¸å­˜åœ¨ |
| Chainlink ä»·æ ¼æº | å®Œæ•´ | æœ‰é™ |
| æµåŠ¨æ€§ | å……è¶³ | æµ‹è¯•ä»£å¸ |
| Gas æˆæœ¬ | çœŸå® ETH | å…è´¹æµ‹è¯• ETH |

### 5. æ–‡æ¡£åŒ–æ‰€æœ‰æ›´æ”¹
- è®°å½•æ¯æ¬¡éƒ¨ç½²çš„åˆçº¦åœ°å€
- è®°å½•é…ç½®å‚æ•°
- è®°å½•é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

## ğŸ“ éœ€è¦ç”¨æˆ·è¾“å…¥

1. **æ˜¯å¦éœ€è¦éƒ¨ç½² Routerï¼Ÿ** - å¼ºçƒˆæ¨èï¼Œä½†ä¼šå¢åŠ  gas æˆæœ¬
2. **æ˜¯å¦éœ€è¦çœŸå®ä»·æ ¼æºï¼Ÿ** - è¿˜æ˜¯ Mock Oracle è¶³å¤Ÿç”¨äºæµ‹è¯•
3. **æ˜¯å¦éœ€è¦å®Œæ•´çš„çŸ­ä»“åŠŸèƒ½ï¼Ÿ** - è¿˜æ˜¯åªæµ‹è¯•é•¿ä»“

## ğŸ”— æœ‰ç”¨çš„èµ„æº

- è¯Šæ–­è„šæœ¬: `scripts/diagnose-sepolia-readonly.ts`
- éƒ¨ç½²æ¨¡å—: `ignition/modules/`
- éƒ¨ç½²å‚æ•°: `ignition/parameters/`
- ä¸»ç½‘éƒ¨ç½²è®°å½•: `ignition/deployments/ethereum/deployed_addresses.json`

---

**ä¸‹ä¸€æ­¥**: åˆ›å»ºä¿®å¤è„šæœ¬å¹¶æ‰§è¡Œé˜¶æ®µ 1 çš„ç´§æ€¥ä¿®å¤


