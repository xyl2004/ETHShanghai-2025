'use client';

import { useState, useEffect } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContracts, useReadContract, useWatchContractEvent, useChainId, useSwitchChain } from 'wagmi';
import { optimismSepolia } from 'wagmi/chains';
import { CONTRACTS, PAYMENT_GATEWAY_ABI } from '@/lib/contracts';
import { fetchAIPrediction, type AIPrediction } from '@/lib/oracle-api';
import { uploadOrderMetadataToIPFS, type OrderMetadata } from '@/lib/ipfs';
import { TOKENS, getTokenInfo, getTokenSymbol, getDefaultRate, SUPPORTED_AI_PAIRS } from '@/lib/tokens';
import { parseUnits } from 'viem';
import DashboardLayout from '@/components/DashboardLayout';
import Link from 'next/link';
import toast from 'react-hot-toast';

// PublicGoodsFund ABI
const PUBLIC_GOODS_FUND_ABI = [
  {
    "inputs": [],
    "name": "totalLifetimeDonations",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getTotalContributors",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
    "name": "getContributorInfo",
    "outputs": [
      {"internalType": "uint256", "name": "totalContributed", "type": "uint256"},
      {"internalType": "uint256", "name": "lastContributionTime", "type": "uint256"},
      {"internalType": "string", "name": "badgeLevel", "type": "string"}
    ],
    "stateMutability": "view",
    "type": "function"
  }
] as const;

export default function CreateOrderPage() {
  const { address, isConnected } = useAccount();
  const { writeContract, data: hash, isPending, isError: isWriteError, error: writeError } = useWriteContract();
  const chainId = useChainId();
  const { switchChain } = useSwitchChain();


  // ç­‰å¾…äº¤æ˜“ç¡®è®¤
  const { isLoading: isConfirming, isSuccess: isConfirmed, isError: isTxError, error: txError, data: txReceipt } = useWaitForTransactionReceipt({
    hash,
  });

  // ğŸ†• Monitor write errors (user rejection, etc.)
  useEffect(() => {
    if (isWriteError && writeError) {
      console.error('âŒ Write contract error:', writeError);
      const msg = (writeError as any)?.shortMessage || (writeError as Error).message || 'Transaction failed';

      // Check if user rejected
      if (msg.includes('User rejected') || msg.includes('user rejected')) {
        toast.error('Transaction rejected by user');
      } else {
        toast.error(`Transaction failed: ${msg}`);
      }
    }
  }, [isWriteError, writeError]);

  // ğŸ†• Monitor transaction hash
  useEffect(() => {
    if (hash) {
      console.log('âœ… Transaction hash received:', hash);
      toast.success(`Transaction submitted: ${hash.slice(0, 10)}...`);
    }
  }, [hash]);

  // Display result / errors for transaction
  useEffect(() => {
    if (isConfirmed) {
      console.log('âœ… Transaction confirmed!');
      toast.success('âœ… Order created on-chain successfully');
    }
    if (isTxError && txError) {
      const msg = (() => {
        const m = (txError as any)?.message?.match(/revert(?:ed)?(?: with reason string)?[: ]+([^\n]+)/i);
        return m?.[1]?.trim() || (txError as any)?.shortMessage || (txError as Error).message || 'Transaction failed';
      })();
      toast.error(`On-chain execution failed: ${msg}`);
      console.error('Transaction error:', txError);
    }
  }, [isConfirmed, isTxError, txError]);

  // ğŸ†• Debug: Log transaction status
  useEffect(() => {
    if (hash) {
      console.log('ğŸ“Š Transaction Status:', {
        hash,
        isPending,
        isConfirming,
        isConfirmed,
        isTxError,
        txReceipt: txReceipt ? 'Received' : 'Pending'
      });
    }
  }, [hash, isPending, isConfirming, isConfirmed, isTxError, txReceipt]);

  // ğŸ†• è¿½è¸ªå½“å‰æ“ä½œç±»å‹
  const [currentOperation, setCurrentOperation] = useState<'register' | 'createOrder' | null>(null);

  // è¡¨å•æ•°æ® - é»˜è®¤é€‰æ‹©USDC/USDT (å·²éƒ¨ç½²çš„Token)
  const [formData, setFormData] = useState({
    orderId: '',
    amount: '',
    description: '',
    buyerEmail: '',
    buyerAddress: '',  // ğŸ†• ä¹°å®¶é’±åŒ…åœ°å€ï¼ˆå¯é€‰ï¼Œç•™ç©ºè¡¨ç¤ºå…¬å¼€è®¢å•ï¼‰
    paymentToken: CONTRACTS.MOCK_USDC,  // âœ… é»˜è®¤é€‰æ‹©å·²æ”¯æŒçš„USDC
    settlementToken: CONTRACTS.MOCK_USDT,  // âœ… é»˜è®¤é€‰æ‹©å·²æ”¯æŒçš„USDT
  });

  // AIé¢„æµ‹æ•°æ®
  const [aiPrediction, setAiPrediction] = useState<AIPrediction | null>(null);
  const [isLoadingAI, setIsLoadingAI] = useState(false);
  const [refreshCountdown, setRefreshCountdown] = useState(5);

  // ç”ŸæˆäºŒç»´ç çŠ¶æ€
  const [showPaymentSection, setShowPaymentSection] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [qrCodeDataUrl, setQrCodeDataUrl] = useState<string>('');

  // ğŸ†• Read merchant registration status
  const { data: merchantInfo, refetch: refetchMerchantInfo } = useReadContract({
    address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
    abi: PAYMENT_GATEWAY_ABI,
    functionName: 'getMerchantInfo',
    args: address ? [address as `0x${string}`] : undefined,
    query: {
      enabled: isConnected && !!address,
    }
  });

  const isMerchantRegistered = merchantInfo ? (merchantInfo as any)[5] === true : false; // isActive field

  // ğŸ†• Check token support on-chain for the selected tokens
  const { data: tokenSupport } = useReadContracts({
    contracts: isConnected ? [
      {
        address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
        abi: PAYMENT_GATEWAY_ABI,
        functionName: 'supportedTokens',
        args: [formData.paymentToken as `0x${string}`],
      },
      {
        address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
        abi: PAYMENT_GATEWAY_ABI,
        functionName: 'supportedTokens',
        args: [formData.settlementToken as `0x${string}`],
      },
    ] : [],
    query: { enabled: isConnected },
  });

  const isPaymentTokenSupported = !!(tokenSupport as any)?.[0]?.result;
  const isSettlementTokenSupported = !!(tokenSupport as any)?.[1]?.result;


  // ğŸ†• Debug: Log token support status
  useEffect(() => {
    if (tokenSupport) {
      console.log('ğŸ” Token Support Status:', {
        paymentToken: formData.paymentToken,
        settlementToken: formData.settlementToken,
        paymentSupported: isPaymentTokenSupported,
        settlementSupported: isSettlementTokenSupported,
        rawData: tokenSupport
      });
    }
  }, [tokenSupport, formData.paymentToken, formData.settlementToken, isPaymentTokenSupported, isSettlementTokenSupported]);


  // è¯»å–çœŸå®é“¾ä¸Šæ•°æ®
  const { data: chainData } = useReadContracts({
    contracts: isConnected ? [
      // å…¬ç›ŠåŸºé‡‘æ•°æ®
      {
        address: CONTRACTS.PUBLIC_GOODS_FUND as `0x${string}`,
        abi: PUBLIC_GOODS_FUND_ABI,
        functionName: 'totalLifetimeDonations',
      },
      {
        address: CONTRACTS.PUBLIC_GOODS_FUND as `0x${string}`,
        abi: PUBLIC_GOODS_FUND_ABI,
        functionName: 'getTotalContributors',
      },
      // å•†æˆ·è®¢å•æ•°æ®
      {
        address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
        abi: PAYMENT_GATEWAY_ABI,
        functionName: 'getMerchantOrders',
        args: [address as `0x${string}`, BigInt(0), BigInt(5)], // è·å–æœ€è¿‘5ä¸ªè®¢å•
      },
      // ç”¨æˆ·è´¡çŒ®ä¿¡æ¯
      {
        address: CONTRACTS.PUBLIC_GOODS_FUND as `0x${string}`,
        abi: PUBLIC_GOODS_FUND_ABI,
        functionName: 'getContributorInfo',
        args: [address as `0x${string}`],
      },
    ] : [],
    // æ·»åŠ enabledæ¡ä»¶ï¼Œåªæœ‰Connect Walletåæ‰æŸ¥è¯¢
    enabled: isConnected && !!address,
  });

  // è§£æé“¾ä¸Šæ•°æ®
  const rawTotalLifetimeDonations = chainData?.[0]?.result ? Number(chainData[0].result) / 1e6 : 0;
  const rawTotalContributors = chainData?.[1]?.result ? Number(chainData[1].result) : 0;
  const merchantOrders = chainData?.[2]?.result as any[] || [];
  const contributorInfo = chainData?.[3]?.result as any;
  const userContributed = contributorInfo ? Number(contributorInfo[0]) / 1e6 : 0;

  // è°ƒè¯•è¾“å‡º
  console.log('ğŸ” Public Goods Data Debug:', {
    contractAddress: CONTRACTS.PUBLIC_GOODS_FUND,
    rawTotalLifetimeDonations,
    rawTotalContributors,
    chainDataRaw: chainData,
    merchantOrders: merchantOrders.length,
    userContributed
  });

  // ç›´æ¥ä½¿ç”¨çœŸå®æ•°æ®
  const totalLifetimeDonations = rawTotalLifetimeDonations;
  const totalContributors = rawTotalContributors;

  // è°ƒè¯•ï¼šæ‰“å°è®¢å•æ•°æ®
  useEffect(() => {
    if (merchantOrders.length > 0) {
      console.log('ğŸ“¦ Merchant Orders:', merchantOrders);
      console.log('ğŸ“¦ First Order:', merchantOrders[0]);
    }
  }, [merchantOrders]);

  // è®¡ç®—æ”¯æŒçš„å¼€å‘è€…æ•°é‡ï¼ˆåŸºäºè´¡çŒ®é¢ï¼‰
  const developersSupported = userContributed > 0 ? (userContributed / 100).toFixed(1) : '0';

  // è‡ªåŠ¨ç”Ÿæˆè®¢å•ID (ä¼˜åŒ–ï¼šæ›´çŸ­æ›´æ˜“è®° + æ·»åŠ éšæœºæ€§ç¡®ä¿å”¯ä¸€)
  useEffect(() => {
    if (!formData.orderId) {
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substring(2, 5).toUpperCase();
      const shortId = `AP${timestamp.slice(-4)}${random}`;
      setFormData(prev => ({ ...prev, orderId: shortId }));
    }
  }, []);

  // Trading Pair
  const tradingPair = `${getTokenSymbol(formData.paymentToken)}/${getTokenSymbol(formData.settlementToken)}`;
  const paymentTokenInfo = getTokenInfo(formData.paymentToken);
  const settlementTokenInfo = getTokenInfo(formData.settlementToken);
  const isStablecoinPair = paymentTokenInfo?.type === 'stablecoin' && settlementTokenInfo?.type === 'stablecoin';

  // æ™ºèƒ½è½¬æ¢Trading Pair - å°†ä¸Supported Trading Pairsè½¬æ¢ä¸ºæ”¯æŒçš„æ ¼å¼
  const getConvertedPair = () => {
    const paymentSymbol = getTokenSymbol(formData.paymentToken);
    const settlementSymbol = getTokenSymbol(formData.settlementToken);

    // å¦‚æœä»˜æ¬¾æ˜¯Cryptocurrencyï¼Œç»“ç®—æ˜¯Stablecoinï¼Œç»Ÿä¸€è½¬æ¢ä¸º XXX/USDT
    if (paymentTokenInfo?.type === 'crypto' && settlementTokenInfo?.type === 'stablecoin') {
      return `${paymentSymbol}/USDT`;
    }

    // å¦‚æœä»˜æ¬¾æ˜¯Stablecoinï¼Œç»“ç®—æ˜¯Cryptocurrencyï¼Œè½¬æ¢ä¸º XXX/USDT ç„¶åå–å€’æ•°
    if (paymentTokenInfo?.type === 'stablecoin' && settlementTokenInfo?.type === 'crypto') {
      return `${settlementSymbol}/USDT`;
    }

    // Fiatå¯¹
    if (paymentTokenInfo?.type === 'fiat' || settlementTokenInfo?.type === 'fiat') {
      // å°è¯•æ ‡å‡†Fiatå¯¹
      if (paymentSymbol === 'EUR' || paymentSymbol === 'GBP' || paymentSymbol === 'CNY') {
        return `${paymentSymbol}/USD`;
      }
    }

    // è¿”å›åŸå§‹Trading Pair
    return tradingPair;
  };

  const convertedPair = getConvertedPair();
  const needsInversion = paymentTokenInfo?.type === 'stablecoin' && settlementTokenInfo?.type === 'crypto';

  // æ£€æŸ¥è½¬æ¢åçš„Trading Pairæ˜¯å¦æ”¯æŒAIé¢„æµ‹
  const isSupportedPair = SUPPORTED_AI_PAIRS.includes(convertedPair);

  // è·å–AIé¢„æµ‹ï¼ˆæ¯5ç§’åˆ·æ–°ï¼‰
  useEffect(() => {
    const fetchPrediction = async () => {
      if (isStablecoinPair) {
        setAiPrediction({
          pair: tradingPair,
          predicted_price: 1.0,
          current_price: 1.0,
          price_change: 0,
          confidence: 1.0,
          prediction_horizon: 'N/A',
          timestamp: new Date().toISOString(),
          meets_threshold: true,
          optimal_settlement_path: {
            name: 'Curve Finance',
            protocol: 'Curve',
            estimated_cost_pct: 0.04,
            settlement_time_seconds: 18,
            reliability: 0.99,
            risk_level: 'low',
            reason: 'Best for stablecoin swaps with minimal slippage',
            alternative_paths: ['FXPool Direct', 'Uniswap V3']
          }
        });
        return;
      }

      // ä½¿ç”¨è½¬æ¢åçš„Trading Pairè°ƒç”¨API
      if (!isSupportedPair) {
        // å¦‚æœè½¬æ¢åä»ä¸æ”¯æŒï¼Œä½¿ç”¨é»˜è®¤å€¼
        const defaultPrice = getDefaultRate(tradingPair);
        if (defaultPrice) {
          setAiPrediction({
            pair: tradingPair,
            predicted_price: defaultPrice,
            current_price: defaultPrice,
            price_change: 0,
            confidence: 0.5,
            prediction_horizon: 'Default',
            timestamp: new Date().toISOString(),
            meets_threshold: false,
          });
        } else {
          setAiPrediction(null);
        }
        setIsLoadingAI(false);
        return;
      }

      setIsLoadingAI(true);
      try {
        // ä½¿ç”¨è½¬æ¢åçš„Trading Pairè°ƒç”¨API
        const prediction = await fetchAIPrediction(convertedPair);

        if (prediction) {
          // å¦‚æœéœ€è¦å–å€’æ•°ï¼ˆStablecoinä¹°Cryptocurrencyçš„æƒ…å†µï¼‰
          if (needsInversion && prediction.predicted_price > 0) {
            prediction.predicted_price = 1 / prediction.predicted_price;
            if (prediction.current_price > 0) {
              prediction.current_price = 1 / prediction.current_price;
            }
          }

          // å¯¹äºCryptocurrencyâ†’Stablecoinçš„æƒ…å†µï¼Œä»·æ ¼å°±æ˜¯æ­£ç¡®çš„
          // æ›´æ–°Trading Pairåç§°ä¸ºå®é™…çš„Trading Pair
          prediction.pair = tradingPair;
        }

        setAiPrediction(prediction);
      } catch (error) {
        console.error('Failed to fetch AI prediction:', error);
        // ä½¿ç”¨é»˜è®¤å€¼ä½œä¸ºåå¤‡
        const defaultPrice = getDefaultRate(tradingPair);
        if (defaultPrice) {
          setAiPrediction({
            pair: tradingPair,
            predicted_price: defaultPrice,
            current_price: defaultPrice,
            price_change: 0,
            confidence: 0.5,
            prediction_horizon: 'Default',
            timestamp: new Date().toISOString(),
            meets_threshold: false,
          });
        } else {
          setAiPrediction(null);
        }
      } finally {
        setIsLoadingAI(false);
      }
    };

    fetchPrediction();
    const interval = setInterval(() => {
      fetchPrediction();
      setRefreshCountdown(5);
    }, 5000);

    const countdownInterval = setInterval(() => {
      setRefreshCountdown(prev => prev > 0 ? prev - 1 : 5);
    }, 1000);

    return () => {
      clearInterval(interval);
      clearInterval(countdownInterval);
    };
  }, [tradingPair, isStablecoinPair, isSupportedPair, convertedPair, needsInversion]);

  // ğŸ†• Real-time order creation listener
  useWatchContractEvent({
    address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
    abi: PAYMENT_GATEWAY_ABI,
    eventName: 'OrderCreated',
    onLogs(logs) {
      console.log('ğŸ“¦ Order created event detected:', logs);
      // Only show toast if this is the user's order
      const log = logs[0] as any;
      if (log.args?.merchant?.toLowerCase() === address?.toLowerCase()) {
        toast.success('ğŸ‰ Order created successfully on-chain!');
      }
    },
  });

  // è´¹ç”¨è®¡ç®—
  const orderAmount = parseFloat(formData.amount || '0');
  const defaultRate = getDefaultRate(tradingPair);
  const aiRate = aiPrediction?.predicted_price || defaultRate || 1.0;
  const expectedAmount = orderAmount * aiRate;

  const platformFeeRate = 0.006; // 0.6%
  const platformFee = expectedAmount * platformFeeRate;
  const donationAmount = platformFee * 0.05;
  const merchantReceives = expectedAmount - platformFee;

  // å¯¹æ¯”ä¼ ç»Ÿæ”¯ä»˜
  const stripeFee = orderAmount * 0.029 + 0.30;
  const paypalFee = orderAmount * 0.034 + 0.49;
  const savedVsStripe = stripeFee - platformFee;

  // ç”ŸæˆäºŒç»´ç 
  const handleGenerateQR = async () => {
    if (!formData.amount || !formData.description) {
      toast.error('Please fill in Order Amount and Product Description');
      return;
    }

    setIsGenerating(true);
    try {
      // åŠ¨æ€å¯¼å…¥QRCodeåº“
      const QRCode = (await import('qrcode')).default;

      // ç”ŸæˆPayment Link
      const paymentUrl = `${window.location.origin}/pay/${formData.orderId}`;

      // ç”ŸæˆäºŒç»´ç 
      const qrDataUrl = await QRCode.toDataURL(paymentUrl, {
        width: 256,
        margin: 2,
        color: {
          dark: '#10B981',  // ç»¿è‰²
          light: '#FFFFFF'
        }
      });

      setQrCodeDataUrl(qrDataUrl);
      setShowPaymentSection(true);
      toast.success('QR Code generated successfully!');
    } catch (error) {
      console.error('Failed to generate QR code:', error);
      toast.error(`Failed to generate QR code: ${(error as Error).message}`);
    } finally {
      setIsGenerating(false);
    }
  };

  // ğŸ†• Register as Merchant
  const handleRegisterMerchant = async () => {
    if (!address) {
      toast.error('Please connect your wallet first');
      return;
    }

    try {
      const businessName = prompt('Enter your business name:', 'My Business');
      if (!businessName || businessName.trim() === '') {
        toast.error('Business name is required');
        return;
      }

      console.log('ğŸ”„ Registering merchant:', businessName);

      setCurrentOperation('register'); // ğŸ†• è®¾ç½®æ“ä½œç±»å‹

      writeContract({
        address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
        abi: PAYMENT_GATEWAY_ABI,
        functionName: 'registerMerchant',
        args: [businessName.trim()],
      });

      // Wait for confirmation and refetch merchant info
      setTimeout(() => {
        refetchMerchantInfo();
      }, 3000);

      toast.success('Merchant registration submitted!');
    } catch (error) {
      console.error('âŒ Merchant registration failed:', error);
      toast.error(`Registration failed: ${(error as Error).message}`);
    }
  };

  // åˆ›å»ºè®¢å•
  const handleCreateOrder = async () => {
    if (!formData.amount) {
      toast.error('Please fill in Order Amount');
      return;
    }

    if (!formData.description) {
      toast.error('Please fill in Product Description');
      return;
    }

    try {
      console.log('ğŸ”„ Step 1: Uploading metadata to IPFS...');

      // ğŸ†• Step 1: ä¸Šä¼ å…ƒæ•°æ®åˆ° IPFS

      // Preflight on-chain validations
      if (!isMerchantRegistered) {
        toast.error('Please register as a merchant before creating orders');
        return;
      }

      // Network check
      if (chainId !== optimismSepolia.id) {
        toast.error('Please switch to Optimism Sepolia network');
        try {
          switchChain({ chainId: optimismSepolia.id });
        } catch (e) {
          console.error('Network switch failed:', e);
        }
        return;
      }

      if (!isPaymentTokenSupported) {
        toast.error('Selected payment token is not supported by the contract');
        return;
      }
      if (!isSettlementTokenSupported) {
        toast.error('Selected settlement token is not supported by the contract');
        return;
      }

      const metadata: OrderMetadata = {
        orderId: formData.orderId,
        description: formData.description,
        buyerEmail: formData.buyerEmail,
        createdAt: new Date().toISOString(),
        merchantAddress: address as string,
        additionalInfo: {
          paymentToken: getTokenSymbol(formData.paymentToken),
          settlementToken: getTokenSymbol(formData.settlementToken),
          tradingPair: tradingPair,
          aiPrediction: aiPrediction ? {
            rate: aiPrediction.predicted_price,
            confidence: aiPrediction.confidence
          } : undefined
        }
      };

      const ipfsCID = await uploadOrderMetadataToIPFS(metadata);
      console.log('âœ… Metadata uploaded to IPFS:', ipfsCID);
      toast.success('Metadata uploaded to IPFS');

      // ğŸ†• Step 2: Create On-Chain Orderï¼ˆåŒ…å« IPFS CIDï¼‰
      console.log('ğŸ”„ Step 2: Creating order on-chain...');

      const amountInWei = parseUnits(formData.amount, 6);

      console.log('ğŸ“¤ Submitting transaction with params:', {
        orderId: formData.orderId,
        amount: amountInWei.toString(),
        paymentToken: formData.paymentToken,
        settlementToken: formData.settlementToken,
        ipfsCID,
        allowPartialPayment: false
      });

      setCurrentOperation('createOrder'); // ğŸ†• è®¾ç½®æ“ä½œç±»å‹

      // ğŸ†• å¤„ç†ä¹°å®¶åœ°å€ï¼šå¦‚æœä¸ºç©ºæˆ–æ— æ•ˆï¼Œä½¿ç”¨ address(0) è¡¨ç¤ºå…¬å¼€è®¢å•
      console.log('ğŸ” DEBUG: Buyer Address Field Value:', {
        rawValue: formData.buyerAddress,
        valueType: typeof formData.buyerAddress,
        valueLength: formData.buyerAddress?.length,
        trimmedValue: formData.buyerAddress?.trim(),
        trimmedLength: formData.buyerAddress?.trim().length,
        startsWithOx: formData.buyerAddress?.startsWith('0x'),
        isValidLength: formData.buyerAddress?.length === 42,
        isEmpty: !formData.buyerAddress || formData.buyerAddress.trim() === ''
      });

      const designatedPayer = formData.buyerAddress && formData.buyerAddress.trim() !== '' && formData.buyerAddress.startsWith('0x') && formData.buyerAddress.length === 42
        ? formData.buyerAddress as `0x${string}`
        : '0x0000000000000000000000000000000000000000' as `0x${string}`;

      console.log('ğŸ” DEBUG: Designated Payer Decision:', {
        designatedPayer,
        isPublicOrder: designatedPayer === '0x0000000000000000000000000000000000000000',
        buyerAddressWasEmpty: !formData.buyerAddress || formData.buyerAddress.trim() === ''
      });

      writeContract({
        address: CONTRACTS.PAYMENT_GATEWAY_V2 as `0x${string}`,
        abi: PAYMENT_GATEWAY_ABI,
        functionName: 'createOrder',
        args: [
          formData.orderId,
          amountInWei,
          formData.paymentToken as `0x${string}`,
          formData.settlementToken as `0x${string}`,
          ipfsCID,  // ğŸ†• ä¼ é€’ IPFS CID
          false,  // ğŸ†• allowPartialPayment - é»˜è®¤ä¸å…è®¸éƒ¨åˆ†æ”¯ä»˜
          designatedPayer  // ğŸ†• æŒ‡å®šä¹°å®¶åœ°å€ï¼ˆaddress(0) è¡¨ç¤ºå…¬å¼€è®¢å•ï¼‰
        ],
      });

      console.log('âœ… Transaction request sent to wallet');
      toast('Please confirm the transaction in your wallet...', {
        icon: 'â„¹ï¸',
        duration: 4000,
      });
    } catch (error) {
      console.error('âŒ Order creation failed:', error);

      // Extract revert reason if available
      const errorMessage = (() => {
        const err = error as any;

        // Check for revert reason in error message
        const revertMatch = err?.message?.match(/reverted with reason string '([^']+)'/);
        if (revertMatch) return revertMatch[1];

        // Check for custom error
        const customErrorMatch = err?.message?.match(/reverted with custom error '([^']+)'/);
        if (customErrorMatch) return customErrorMatch[1];

        // Check for execution reverted
        if (err?.message?.includes('execution reverted')) {
          return err.message.split('execution reverted')[1]?.trim() || 'Transaction reverted';
        }

        // Check shortMessage from wagmi
        if (err?.shortMessage) return err.shortMessage;

        // Fallback to full message
        return err?.message || 'Unknown error';
      })();

      toast.error(`Order creation failed: ${errorMessage}`);
    }
  };

  if (!isConnected) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center min-h-[60vh]">
          <div className="bg-white rounded-xl shadow-sm p-8 text-center max-w-md border border-gray-200">
            <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
        </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Connect Wallet</h2>
            <p className="text-gray-600 mb-6">Please connect your wallet to create an order</p>
      </div>
        </div>
      </DashboardLayout>
    );
  }

  // ğŸ†• Check if on correct network
  if (chainId !== optimismSepolia.id) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center min-h-[60vh]">
          <div className="bg-white rounded-xl shadow-sm p-8 text-center max-w-md border border-gray-200">
            <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Wrong Network</h2>
            <p className="text-gray-600 mb-4">
              You are currently on <span className="font-semibold text-red-600">
                {chainId === 1 ? 'Ethereum Mainnet' : `Chain ID ${chainId}`}
              </span>
            </p>
            <p className="text-gray-600 mb-6">
              Please switch to <span className="font-semibold text-emerald-600">Optimism Sepolia</span> testnet
            </p>
              <button
              onClick={() => {
                try {
                  switchChain({ chainId: optimismSepolia.id });
                } catch (e) {
                  console.error('Network switch failed:', e);
                  toast.error('Failed to switch network. Please switch manually in MetaMask.');
                }
              }}
              className="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium"
            >
              Switch to Optimism Sepolia
              </button>
            <div className="mt-4 text-xs text-gray-500">
              <p>Network: Optimism Sepolia</p>
              <p>Chain ID: 11155420</p>
              <p>RPC: https://sepolia.optimism.io</p>
            </div>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // ğŸ†• å¦‚æœæ­£åœ¨ç­‰å¾…äº¤æ˜“ç¡®è®¤ï¼Œæ˜¾ç¤ºç­‰å¾…ç•Œé¢
  if (isConfirming && hash) {
    const explorerUrl = `https://sepolia-optimism.etherscan.io/tx/${hash}`;

    return (
      <DashboardLayout>
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-xl shadow-sm p-8 border border-gray-200 text-center">
            <div className="animate-spin h-16 w-16 border-4 border-emerald-500 rounded-full border-t-transparent mx-auto mb-6"></div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">â³ Waiting for Confirmation</h2>
            <p className="text-gray-600 mb-4">
              Your transaction is being processed on the blockchain...
            </p>
            <p className="text-sm text-gray-500 mb-6">
              This usually takes 10-30 seconds on Optimism Sepolia testnet
            </p>

            <div className="bg-gray-50 rounded-lg p-4 mb-4">
              <div className="text-sm text-gray-600 mb-2">Transaction Hash</div>
              <div className="font-mono text-xs text-gray-900 break-all mb-3">{hash}</div>

              <a
                href={explorerUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm font-medium"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                View on Block Explorer
              </a>
            </div>

            <button
                onClick={() => window.location.reload()}
              className="mt-4 px-4 py-2 text-gray-600 hover:text-gray-900 text-sm font-medium"
            >
              Cancel & Start Over
            </button>
            </div>
          </div>
      </DashboardLayout>
    );
  }

  if (isConfirmed) {
    // ğŸ†• æ ¹æ®æ“ä½œç±»å‹æ˜¾ç¤ºä¸åŒçš„æˆåŠŸé¡µé¢
    if (currentOperation === 'register') {
      return (
        <DashboardLayout>
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-xl shadow-sm p-8 border border-gray-200 text-center">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                <svg className="w-8 h-8 text-green-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
        </div>
              <h2 className="text-2xl font-bold text-gray-900 mb-2">âœ… Merchant Registration Successful!</h2>
              <p className="text-gray-600 mb-4">Transaction Hash: {hash?.slice(0, 10)}...{hash?.slice(-8)}</p>
              <p className="text-sm text-gray-500 mb-6">
                You are now registered as a merchant. You can start creating payment orders!
              </p>
              <button
                onClick={() => {
                  setCurrentOperation(null);
                  window.location.reload();
                }}
                className="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium"
              >
                Start Creating Orders
              </button>
      </div>
          </div>
        </DashboardLayout>
    );
  }

    // åˆ›å»ºè®¢å•æˆåŠŸé¡µé¢
    const paymentUrl = `${window.location.origin}/pay/${formData.orderId}`;

  return (
      <DashboardLayout>
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-xl shadow-sm p-8 border border-gray-200">
            {/* Success Notice */}
            <div className="text-center mb-8 pb-8 border-b border-gray-200">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                <svg className="w-8 h-8 text-green-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
            </div>
              <h2 className="text-2xl font-bold text-gray-900 mb-2">ğŸ‰ Order Created Successfully!</h2>
              <p className="text-gray-600">Transaction Hash: {hash?.slice(0, 10)}...{hash?.slice(-8)}</p>
          </div>

            {/* Order Details */}
            <div className="grid md:grid-cols-2 gap-6 mb-6">
              <div className="space-y-3">
                <h3 className="font-semibold text-gray-900 mb-4">Order Information</h3>
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">Order Number</div>
                  <div className="font-mono text-sm text-gray-900">{formData.orderId}</div>
              </div>
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">Order Amount</div>
                  <div className="text-xl font-bold text-gray-900">{formData.amount} {getTokenSymbol(formData.paymentToken)}</div>
                </div>
              </div>

              <div className="space-y-3">
                <h3 className="font-semibold text-gray-900 mb-4">Payment Link</h3>
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-2">Share with Buyer</div>
              <div className="flex gap-2">
                <input
                  type="text"
                      value={paymentUrl}
                      readOnly
                      className="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-sm font-mono text-gray-900"
                />
                <button
                      onClick={() => {
                        navigator.clipboard.writeText(paymentUrl);
                        toast.success('Payment link copied to clipboard!');
                      }}
                      className="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 text-sm font-medium"
                    >
                      Copy
                </button>
              </div>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-3">
              <Link
                href="/dashboard/orders"
                className="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium text-center"
              >
                View Order List
              </Link>
              <button
                onClick={() => window.location.reload()}
                className="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium"
              >
                Create New Order
              </button>
            </div>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="">
        {/* Page Title */}
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-gray-900">Create Payment Order</h1>
          <p className="text-gray-600 mt-2">AI-optimized exchange rates, save 80% in fees for customers</p>
          </div>

        {/* ğŸ†• Merchant Registration Warning */}
        {!isMerchantRegistered && (
          <div className="mb-6 bg-amber-50 border border-amber-200 rounded-xl p-6">
            <div className="flex items-start gap-4">
              <div className="flex-shrink-0">
                <svg className="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-amber-900 mb-2">Merchant Registration Required</h3>
                <p className="text-amber-800 mb-4">
                  You need to register as a merchant before creating payment orders. This is a one-time setup that takes just a few seconds.
                </p>
                <button
                  onClick={handleRegisterMerchant}
                  disabled={isPending}
                  className="px-6 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                  </svg>
                  {isPending ? 'Registering...' : 'Register as Merchant'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ğŸ†• Success Message for Registered Merchants */}
        {isMerchantRegistered && (
          <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="text-green-800 font-medium">âœ… Merchant account active - You can create orders</span>
            </div>
          </div>
        )}

        {/* ğŸ†• Debug Panel: Token Support Status */}
        {isConnected && (
          <div className="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="text-sm font-medium text-blue-900 mb-2">ğŸ” Debug: Contract Status</div>
            <div className="space-y-1 text-xs text-blue-800 font-mono">
              <div>Contract: {CONTRACTS.PAYMENT_GATEWAY_V2}</div>
              <div>Payment Token ({getTokenSymbol(formData.paymentToken)}): {
                isPaymentTokenSupported === undefined ? 'â³ Loading...' :
                isPaymentTokenSupported ? 'âœ… Supported' : 'âŒ NOT Supported'
              }</div>
              <div>Settlement Token ({getTokenSymbol(formData.settlementToken)}): {
                isSettlementTokenSupported === undefined ? 'â³ Loading...' :
                isSettlementTokenSupported ? 'âœ… Supported' : 'âŒ NOT Supported'
              }</div>
              <div>Merchant Status: {isMerchantRegistered ? 'âœ… Registered' : 'âŒ Not Registered'}</div>
              <div>Network: {chainId === 11155420 ? 'âœ… Optimism Sepolia' : `âŒ Wrong (${chainId})`}</div>
            </div>
          </div>
        )}


        <div className="grid lg:grid-cols-3 gap-6">
          {/* Left: Order Form */}
          <div className="lg:col-span-2 space-y-6">
            {/* Basic Information */}
            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 bg-emerald-100 rounded flex items-center justify-center text-emerald-600 font-semibold text-sm">
                  1
                </div>
                <h2 className="text-lg font-semibold text-gray-900">Order Details</h2>
            </div>

              <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                    Order Amount <span className="text-red-500">*</span>
              </label>
                  <div className="relative">
              <input
                type="number"
                step="0.01"
                value={formData.amount}
                onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                placeholder="100.00"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900"
              />
                    <div className="absolute right-3 top-3 text-gray-500 font-medium">
                      USD
                    </div>
                  </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                    Product Description <span className="text-red-500">*</span>
              </label>
                  <textarea
                    value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    placeholder="e.g. Cross-border e-commerce order #12345"
                    rows={3}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900"
                  />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                    Buyer Email <span className="text-gray-400">(Optional)</span>
              </label>
                  <input
                    type="email"
                    value={formData.buyerEmail}
                    onChange={(e) => setFormData({ ...formData, buyerEmail: e.target.value })}
                    placeholder="buyer@example.com"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900"
                  />
                </div>

                {/* ğŸ†• ä¹°å®¶é’±åŒ…åœ°å€è¾“å…¥æ¡† */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Buyer Wallet Address <span className="text-gray-400">(Optional - Leave empty for public order)</span>
                  </label>
                  <input
                    type="text"
                    value={formData.buyerAddress}
                    onChange={(e) => setFormData({ ...formData, buyerAddress: e.target.value })}
                    placeholder="0x... (Leave empty to allow anyone to pay)"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900 font-mono text-sm"
                  />
                  <div className="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <div className="flex items-start gap-2">
                      <span className="text-amber-600 text-sm">âš ï¸</span>
                      <div className="text-xs text-amber-800">
                        <strong>Important:</strong> If you enter an address here, ONLY that specific wallet will be able to pay this order.
                        <strong className="text-amber-900"> Leave this field EMPTY if you want to create a public order that anyone can pay.</strong>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Payment Currency</label>
              <select
                value={formData.paymentToken}
                onChange={(e) => setFormData({ ...formData, paymentToken: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900"
                    >
                      <optgroup label="ğŸª™ Stablecoin">
                        {TOKENS.filter(t => t.type === 'stablecoin').map(token => (
                          <option key={token.address} value={token.address}>{token.symbol} - {token.name}</option>
                        ))}
                      </optgroup>
                      <optgroup label="ğŸŒ Cryptocurrency">
                        {TOKENS.filter(t => t.type === 'crypto').map(token => (
                          <option key={token.address} value={token.address}>{token.symbol} - {token.name}</option>
                        ))}
                      </optgroup>
                      <optgroup label="ğŸ’± Fiat">
                        {TOKENS.filter(t => t.type === 'fiat').map(token => (
                          <option key={token.address} value={token.address}>{token.symbol} - {token.name}</option>
                        ))}
                      </optgroup>
              </select>
            </div>

            <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Settlement Currency</label>
              <select
                value={formData.settlementToken}
                onChange={(e) => setFormData({ ...formData, settlementToken: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900"
                    >
                      <optgroup label="ğŸª™ Stablecoin">
                        {TOKENS.filter(t => t.type === 'stablecoin').map(token => (
                          <option key={token.address} value={token.address}>{token.symbol} - {token.name}</option>
                        ))}
                      </optgroup>
                      <optgroup label="ğŸŒ Cryptocurrency">
                        {TOKENS.filter(t => t.type === 'crypto').map(token => (
                          <option key={token.address} value={token.address}>{token.symbol} - {token.name}</option>
                        ))}
                      </optgroup>
                      <optgroup label="ğŸ’± Fiat">
                        {TOKENS.filter(t => t.type === 'fiat').map(token => (
                          <option key={token.address} value={token.address}>{token.symbol} - {token.name}</option>
                        ))}
                      </optgroup>
              </select>
                  </div>
                </div>
              </div>
            </div>

            {/* Comparison with Traditional Payment */}
            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 bg-emerald-100 rounded flex items-center justify-center text-emerald-600 font-semibold text-sm">
                  3
                </div>
                <h2 className="text-lg font-semibold text-gray-900">Comparison with Traditional Payment</h2>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b border-gray-200">
                      <th className="text-left py-3 px-4 text-sm font-semibold text-gray-700">Payment Method</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">Rate</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">Fee</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">Merchant Receives</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-gray-700">Savings</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr className="border-b border-gray-100 bg-emerald-50">
                      <td className="py-3 px-4">
                        <div className="flex items-center gap-2">
                          <div className="w-6 h-6 bg-emerald-600 rounded flex items-center justify-center">
                            <span className="text-white text-xs font-bold">A</span>
                </div>
                          <span className="font-semibold text-gray-900">AetherPay</span>
                          <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium">Best</span>
                </div>
                      </td>
                      <td className="text-right py-3 px-4 text-gray-900">0.6%</td>
                      <td className="text-right py-3 px-4 text-gray-900">${platformFee.toFixed(2)}</td>
                      <td className="text-right py-3 px-4 text-gray-900">${merchantReceives.toFixed(2)}</td>
                      <td className="text-right py-3 px-4 font-semibold text-green-600">Baseline</td>
                    </tr>
                    <tr className="border-b border-gray-100">
                      <td className="py-3 px-4 flex items-center gap-2">
                        <div className="w-6 h-6 bg-gray-600 rounded flex items-center justify-center">
                          <span className="text-white text-xs font-bold">S</span>
                </div>
                        <span className="text-gray-700">Stripe</span>
                      </td>
                      <td className="text-right py-3 px-4 text-gray-600">2.9% + $0.30</td>
                      <td className="text-right py-3 px-4 text-gray-600">${stripeFee.toFixed(2)}</td>
                      <td className="text-right py-3 px-4 text-gray-600">${(orderAmount - stripeFee).toFixed(2)}</td>
                      <td className="text-right py-3 px-4 text-red-600">-${savedVsStripe.toFixed(2)}</td>
                    </tr>
                    <tr className="border-b border-gray-100">
                      <td className="py-3 px-4 flex items-center gap-2">
                        <div className="w-6 h-6 bg-gray-500 rounded flex items-center justify-center">
                          <span className="text-white text-xs font-bold">P</span>
                        </div>
                        <span className="text-gray-700">PayPal</span>
                      </td>
                      <td className="text-right py-3 px-4 text-gray-600">3.4% + $0.49</td>
                      <td className="text-right py-3 px-4 text-gray-600">${paypalFee.toFixed(2)}</td>
                      <td className="text-right py-3 px-4 text-gray-600">${(orderAmount - paypalFee).toFixed(2)}</td>
                      <td className="text-right py-3 px-4 text-red-600">-${(paypalFee - platformFee).toFixed(2)}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {orderAmount > 0 && (
                <div className="mt-4 bg-green-50 border border-green-200 rounded-lg p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm font-medium text-green-900">Save per order with AetherPay</div>
                      <div className="text-xs text-green-700 mt-1">vs Stripe</div>
                    </div>
                    <div className="text-2xl font-bold text-green-700">
                      ${savedVsStripe.toFixed(2)}
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className="grid grid-cols-2 gap-4">
              <button
                onClick={handleGenerateQR}
                disabled={isGenerating || !formData.amount || !formData.description}
                className="px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium flex items-center justify-center gap-2"
              >
                {isGenerating ? (
                  <>
                    <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating...
                  </>
                ) : (
                  <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                    </svg>
                    Generate Payment QR Code
                  </>
                )}
              </button>

              <button
                onClick={handleCreateOrder}
                disabled={
                  isPending ||
                  isConfirming ||
                  !formData.amount ||
                  !isMerchantRegistered ||
                  !isPaymentTokenSupported ||
                  !isSettlementTokenSupported
                }
                className="px-6 py-4 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium flex items-center justify-center gap-2"
              >
                {isPending || isConfirming ? (
                  <>
                    <div className="animate-spin h-5 w-5 border-2 border-white rounded-full border-t-transparent"></div>
                    {isPending ? 'Awaiting Confirmation...' : 'Creating Order...'}
                  </>
                ) : (
                  <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    Create On-Chain Order
                  </>
                )}
              </button>
                </div>

            {/* Display Generated QR Code */}
            {showPaymentSection && qrCodeDataUrl && (
              <div className="bg-gradient-to-br from-emerald-50 to-green-50 rounded-xl shadow-sm p-6 border border-emerald-200">
                <h3 className="text-lg font-semibold text-gray-900 mb-4 text-center">Payment QR Code</h3>
                <div className="flex flex-col items-center">
                  <div className="bg-white p-4 rounded-lg shadow-md">
                    <img src={qrCodeDataUrl} alt="Payment QR Code" className="w-64 h-64" />
                </div>
                  <div className="text-center mt-4">
                    <div className="text-sm text-gray-600 mb-2">Scan QR Code to complete payment</div>
                    <div className="text-2xl font-bold text-emerald-600">
                      {formData.amount} {getTokenSymbol(formData.paymentToken)}
                </div>
                    <div className="text-xs text-gray-500 mt-2">Order ID: {formData.orderId}</div>
                    <div className="mt-4 flex flex-col gap-2">
                      <Link
                        href={`/pay/${formData.orderId}`}
                        target="_blank"
                        className="inline-block px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm font-medium"
                      >
                        Pay Online
                      </Link>
                      <button
                        onClick={() => {
                          const paymentUrl = `${window.location.origin}/pay/${formData.orderId}`;
                          navigator.clipboard.writeText(paymentUrl);
                          toast.success('Payment link copied to clipboard!');
                        }}
                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium"
                      >
                        Copy Link
                      </button>
              </div>
                  </div>
                </div>
              </div>
            )}

            {(isWriteError || isTxError) && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="text-sm text-red-800">
                  Order creation failed, please try again
                  {writeError && <div className="text-xs mt-1">{(writeError as any)?.shortMessage || writeError.message}</div>}
                  {txError && <div className="text-xs mt-1">{(txError as any)?.shortMessage || txError.message}</div>}
                </div>
              </div>
            )}
                  </div>

          {/* Right: Exchange Rate Preview and Public Goods Impact */}
          <div className="space-y-6">
            {/* AIExchange Rate & Fee Preview */}
            <div className="bg-gradient-to-br from-emerald-50 to-green-50 rounded-xl shadow-sm p-6 border border-emerald-200">
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 bg-emerald-100 rounded flex items-center justify-center text-emerald-600 font-semibold text-sm">
                  2
                    </div>
                <h2 className="text-lg font-semibold text-gray-900">Exchange Rate & Fee Preview</h2>
                <div className="ml-auto text-xs text-emerald-600 font-medium">
                  {refreshCountdown}s to refresh
                    </div>
                  </div>

              {/* Trading Pair Information */}
              <div className="bg-white rounded-lg p-3 mb-3 border border-gray-200">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">Trading Pair</span>
                  <div className="flex items-center gap-2">
                    <span className="text-lg font-bold text-gray-900">{tradingPair}</span>
                    {isStablecoinPair && (
                      <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">Stablecoin Pair</span>
                  )}
                </div>
                </div>
                <div className="flex flex-wrap gap-1 mt-2">
                  {paymentTokenInfo && (
                    <span className={`text-xs px-2 py-0.5 rounded font-medium ${
                      paymentTokenInfo.type === 'stablecoin' ? 'bg-green-100 text-green-700' :
                      paymentTokenInfo.type === 'crypto' ? 'bg-purple-100 text-purple-700' :
                      'bg-amber-100 text-amber-700'
                    }`}>
                      {paymentTokenInfo.type === 'stablecoin' ? 'Stablecoin' :
                       paymentTokenInfo.type === 'crypto' ? 'Cryptocurrency' : 'Fiat'}
                    </span>
                  )}
                  <span className="text-xs text-gray-500">â†’</span>
                  {settlementTokenInfo && (
                    <span className={`text-xs px-2 py-0.5 rounded font-medium ${
                      settlementTokenInfo.type === 'stablecoin' ? 'bg-green-100 text-green-700' :
                      settlementTokenInfo.type === 'crypto' ? 'bg-purple-100 text-purple-700' :
                      'bg-amber-100 text-amber-700'
                    }`}>
                      {settlementTokenInfo.type === 'stablecoin' ? 'Stablecoin' :
                       settlementTokenInfo.type === 'crypto' ? 'Cryptocurrency' : 'Fiat'}
                    </span>
                  )}
                </div>
              </div>

              {/* AI Optimal Exchange Rate */}
              <div className="bg-white rounded-lg p-4 mb-3 border border-emerald-100">
                  <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">AI Optimal Exchange Rate</span>
                  {isLoadingAI ? (
                    <div className="flex items-center gap-2">
                      <div className="animate-spin h-4 w-4 border-2 border-emerald-500 rounded-full border-t-transparent"></div>
                      <span className="text-xs text-gray-500">Refreshing...</span>
                  </div>
                  ) : aiPrediction ? (
                    <span className="text-xs text-green-600 font-medium">
                      {(aiPrediction.confidence * 100).toFixed(1)}% Confidence
                    </span>
                  ) : !isSupportedPair && !isStablecoinPair ? (
                    <span className="text-xs text-amber-600 font-medium">This trading pair is not supported</span>
                  ) : null}
                  </div>
                {/* âœ… ä¿®å¤ï¼šå§‹ç»ˆæ˜¾ç¤ºæ•°æ®ï¼Œå³ä½¿åœ¨åŠ è½½æ—¶ä¹Ÿä¿ç•™æ—§æ•°æ® */}
                <div className={isLoadingAI && !aiPrediction ? 'space-y-3 animate-pulse' : ''}>
                  {isLoadingAI && !aiPrediction ? (
                    // ä»…åœ¨é¦–æ¬¡åŠ è½½ä¸”æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºéª¨æ¶å±
                    <>
                      <div className="h-8 bg-gray-200 rounded w-3/4"></div>
                      <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                    </>
                  ) : (
                    // æœ‰æ•°æ®æ—¶å§‹ç»ˆæ˜¾ç¤ºï¼Œåˆ·æ–°æ—¶ä¿ç•™æ—§æ•°æ®
                    <>
                      <div className={`text-2xl font-bold text-gray-900 ${isLoadingAI ? 'opacity-60' : ''}`}>
                        {aiPrediction ? (
                          `1 ${getTokenSymbol(formData.paymentToken)} = ${aiRate.toFixed(4)} ${getTokenSymbol(formData.settlementToken)}`
                        ) : !isSupportedPair && !isStablecoinPair ? (
                          <div className="text-base text-amber-700">
                            This trading pair has no AI model support yet
                            <div className="text-xs text-gray-600 mt-1 font-normal">
                              Please select supported trading pairs or use default rates
                  </div>
                          </div>
                        ) : (
                          `1 ${getTokenSymbol(formData.paymentToken)} = 1.0000 ${getTokenSymbol(formData.settlementToken)}`
                        )}
                    </div>
                      <div className={`text-xs text-gray-600 mt-1 ${isLoadingAI ? 'opacity-60' : ''}`}>
                        Source:  {isStablecoinPair ? 'Stablecoin Fixed Rate' :
                              aiPrediction?.source_count ? `${aiPrediction.source_count} data sources aggregated` :
                              'LightGBM AI Model'}
                  </div>
                      {aiPrediction?.sources && (
                        <div className={`mt-2 flex flex-wrap gap-1 ${isLoadingAI ? 'opacity-60' : ''}`}>
                          {Object.entries(aiPrediction.sources).slice(0, 3).map(([source, price]) => (
                            <span key={source} className="text-xs bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded">
                              {source}: ${price.toFixed(2)}
                        </span>
                          ))}
                          {Object.keys(aiPrediction.sources).length > 3 && (
                            <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">
                              +{Object.keys(aiPrediction.sources).length - 3} more
                            </span>
                          )}
                      </div>
                      )}
                    </>
                  )}
                      </div>
                    </div>

              {/* Merchant Receives */}
              <div className="bg-white rounded-lg p-4 mb-3">
                <div className="flex items-center gap-2 mb-2">
                  <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span className="text-sm font-medium text-gray-700">Merchant Receives</span>
                </div>
                <div className="text-2xl font-bold text-green-600">
                  ${merchantReceives.toFixed(2)}
                    </div>
                    <div className="text-xs text-gray-600 mt-1">
                  Fee (0.6%): -${platformFee.toFixed(2)}
                    </div>
                <div className="text-xs text-emerald-600 mt-1">
                  Public Goods Donation:  ${donationAmount.toFixed(2)}
                  </div>
              </div>
            </div>

            {/* Public Goods Impact - Enhanced */}
            <div className="bg-gradient-to-br from-emerald-50 to-green-50 rounded-xl shadow-sm p-6 border border-emerald-200">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <svg className="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  <h2 className="text-lg font-semibold text-gray-900">Public Goods Impact</h2>
                </div>
                {isConnected && (
                  <div className="flex items-center gap-1 text-xs text-emerald-600">
                    <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span>Live</span>
                </div>
              )}
              </div>

              {/* Total Platform Donations */}
              <div className="bg-white rounded-lg p-4 mb-3 border border-emerald-100">
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm text-gray-600">Platform Total Donations</span>
                  {!isConnected && (
                    <span className="text-xs text-gray-400">Connect wallet to view</span>
                  )}
                  </div>
                <div className="text-3xl font-bold text-emerald-700">
                  {isConnected ? `$${totalLifetimeDonations.toFixed(2)}` : '$0.00'}
                  </div>
                {orderAmount > 0 && (
                  <div className="mt-2 pt-2 border-t border-emerald-100">
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-gray-600">Estimated donation for this order:</span>
                      <span className="font-semibold text-emerald-600">${donationAmount.toFixed(2)}</span>
                  </div>
                  </div>
                )}
              </div>

              {/* Contributors Count */}
              <div className="bg-white rounded-lg p-4 border border-emerald-100">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-gray-700">Supported Developers</span>
                  <span className="text-lg font-bold text-emerald-700">
                    {isConnected ? `${totalContributors}` : '0'} contributors
                    </span>
                  </div>
                {contributorInfo && contributorInfo[0] > 0 && (
                  <div className="mt-2 pt-2 border-t border-emerald-100">
                    <div className="text-xs text-gray-600 mb-1">Your contribution:</div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm font-semibold text-emerald-700">
                        ${(Number(contributorInfo[0]) / 1e6).toFixed(2)}
                      </span>
                      <span className="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full">
                        {contributorInfo[2]} Badge
                      </span>
                    </div>
                    </div>
                  )}
                    </div>

              {/* View Details Button */}
              <Link
                href="/public-goods"
                className="mt-4 block w-full px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium text-center transition-colors"
              >
                View Donation Details
              </Link>
                  </div>

            {/* Recent Orders */}
            <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-gray-900">Recent Orders</h3>
                <div className="flex items-center gap-2">
                  {merchantOrders && merchantOrders.length > 0 && (
                    <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">
                      {merchantOrders.length}
                        </span>
                  )}
                  <Link href="/dashboard/orders" className="text-sm text-emerald-600 hover:text-emerald-700">
                    View All
                  </Link>
                      </div>
                      </div>
              <div className="space-y-2">
                {merchantOrders && merchantOrders.length > 0 ? (
                  merchantOrders.slice(0, 5).map((order, index) => {
                    // å®‰å…¨åœ°è§£æè®¢å•æ•°æ®
                    const orderIdString = order.orderIdString || order[1] || 'Unknown';
                    const orderAmount = order.orderAmount || order[4] || 0;
                    const orderStatus = order.status !== undefined ? Number(order.status) : (order[11] !== undefined ? Number(order[11]) : 0);

                    const statusStyles = {
                      0: 'bg-yellow-100 text-yellow-700',  // Pending
                      1: 'bg-blue-100 text-blue-700',      // Paid
                      2: 'bg-green-100 text-green-700',    // Completed
                      3: 'bg-gray-100 text-gray-700',      // Expired
                    };
                    const statusText = ['Pending', 'Paid', 'Completed', 'Expired'][orderStatus] || 'Unknown';
                    const statusClass = statusStyles[orderStatus as keyof typeof statusStyles] || statusStyles[0];

                    return (
                      <div key={index} className="flex items-center justify-between py-2 px-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors">
                        <div className="flex-1 min-w-0">
                          <div className="text-sm font-medium text-gray-900 truncate">
                            {orderIdString.length > 15 ? `${orderIdString.substring(0, 15)}...` : orderIdString}
                    </div>
                          <div className="text-xs text-gray-600">
                            ${(Number(orderAmount) / 1e6).toFixed(2)}
                </div>
                        </div>
                        <span className={`text-xs px-2 py-1 rounded font-medium ${statusClass} whitespace-nowrap ml-2`}>
                          {statusText}
                        </span>
                      </div>
                    );
                  })
                ) : (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-2">ğŸ“¦</div>
                    <div className="text-gray-500 text-sm">No orders yet</div>
                    <div className="text-gray-400 text-xs mt-1">Create your first order above</div>
                  </div>
                )}
              </div>
            </div>

            {/* Supported Trading Pairs */}
            <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl shadow-sm p-6 border border-purple-200">
              <div className="flex items-center gap-2 mb-4">
                <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                <h3 className="font-semibold text-gray-900">AI Model Support</h3>
                    </div>
              <div className="space-y-3">
                <div className="bg-white rounded-lg p-3">
                  <div className="text-xs font-semibold text-purple-700 mb-2">ğŸŒ Cryptocurrency Models</div>
                  <div className="flex flex-wrap gap-1">
                    {['BTC/USDT', 'ETH/USDT', 'SOL/USDT', 'ADA/USDT', 'BNB/USDT'].map(pair => {
                      const isActive = convertedPair === pair;
                      return (
                        <span
                          key={pair}
                          className={`text-xs px-2 py-0.5 rounded font-medium transition-all ${
                            isActive
                              ? 'bg-purple-600 text-white ring-2 ring-purple-400'
                              : 'bg-purple-100 text-purple-700'
                          }`}
                        >
                          {pair}
                        </span>
                      );
                    })}
                  </div>
                </div>
                <div className="bg-white rounded-lg p-3">
                  <div className="text-xs font-semibold text-amber-700 mb-2">ğŸ’± Fiat Models</div>
                  <div className="flex flex-wrap gap-1">
                    {['EUR/USD', 'GBP/USD', 'CNY/USD'].map(pair => {
                      const isActive = convertedPair === pair;
                      return (
                        <span
                          key={pair}
                          className={`text-xs px-2 py-0.5 rounded font-medium transition-all ${
                            isActive
                              ? 'bg-amber-600 text-white ring-2 ring-amber-400'
                              : 'bg-amber-100 text-amber-700'
                          }`}
                        >
                          {pair}
                    </span>
                      );
                    })}
        </div>
      </div>
                <div className="text-xs text-center mt-3">
                  {isSupportedPair ? (
                    <span className="text-purple-600">
                      âœ¨ Current Trading Pair: <strong>{tradingPair}</strong>
                      {convertedPair !== tradingPair && (
                        <span className="text-xs"> (calculated via {convertedPair} )</span>
                      )}
                      {aiPrediction ? ' (AI model available)' : ' (loading)'}
                    </span>
                  ) : getDefaultRate(tradingPair) ? (
                    <span className="text-amber-600">
                      âš ï¸ Current Trading Pair: <strong>{tradingPair}</strong> (using default rate)
                    </span>
                  ) : (
                    <span className="text-amber-600">
                      âš ï¸ Current Trading Pair: <strong>{tradingPair}</strong> (not supported)
                    </span>
                  )}
                  <div className="text-purple-600 mt-1">
                    LightGBM Model â€¢ 30s Prediction â€¢ 97.4% Accuracy
    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </DashboardLayout>
  );
}
